<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="illidan.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>tbc.txt - TBC PvE Database</title>
    <script>const whTooltips={colorLinks:true,iconizeLinks:true,renameLinks:false,iconSize:'small',hide:{sellprice:true,ilvl:false},dropChance:true,domain:'tbc'};</script>
    <script src="https://wow.zamimg.com/widgets/power.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'terminal-bg': '#222222',
                        'terminal-text': '#ffffff',
                        'terminal-dim': '#cccccc',
                        'terminal-accent': '#1eff00',
                        'wow-rare': '#0070dd',
                        'wow-epic': '#a335ee',
                        'wow-legendary': '#ff8000',
                    },
                    fontFamily: {
                        'mono': ['IBM Plex Mono', 'Courier Prime', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        /* ===== GLOBAL MOBILE OPTIMIZATIONS ===== */
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        * {
            -webkit-tap-highlight-color: rgba(30, 255, 0, 0.1);
        }
        /* Better scrolling on mobile */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #1eff00 #222222;
        }
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #222222;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #1eff00;
            border-radius: 4px;
        }
        /* ===== TERMINAL-SPECIFIC STYLES (not in Tailwind) ===== */
        .ascii-logo {
            white-space: pre;
            font-family: 'Courier Prime', monospace;
            overflow-x: auto;
        }
        .command-line:before {
            content: '$ ';
            color: #1eff00;
        }
        .class-list li {
            border-left: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .class-list li:hover {
            border-left-color: #1eff00;
            padding-left: 1.25rem;
        }
        .class-list li.active {
            border-left-color: #ffffff;
        }
        /* Prevent text selection on interactive elements (mobile) */
        .class-list li,
        .phase-btn,
        .spec-tab {
            -webkit-user-select: none;
            user-select: none;
        }
        /* ===== MOBILE-SPECIFIC OVERRIDES ===== */
        @media (max-width: 767px) {
            body {
                padding: 0.75rem !important;
                font-size: 0.75rem !important;
                overflow-x: hidden !important;
                max-width: 100vw !important;
            }
            header {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            .ascii-logo {
                font-size: 7px !important;
                line-height: 1.1 !important;
                margin-bottom: 0.625rem !important;
            }
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            aside {
                padding: 1rem !important;
            }
            aside h3 {
                font-size: 0.8125rem !important;
            }
            .class-list li {
                padding: 0.625rem 0 !important;
                padding-left: 0.75rem !important;
                font-size: 0.8125rem !important;
                min-height: 48px !important;
                display: flex !important;
                align-items: center !important;
            }
            main {
                padding: 1rem !important;
                overflow-x: hidden !important;
            }
            /* Dynamic content */
            .command-line {
                font-size: 0.6875rem !important;
                margin: 0.75rem 0 !important;
                word-break: break-all;
            }
            h2 {
                font-size: 1rem !important;
                margin-bottom: 0.75rem !important;
            }
            h3 {
                font-size: 0.8125rem !important;
                margin: 0.75rem 0 !important;
            }
            .meta-info {
                font-size: 0.6875rem !important;
                padding: 0.625rem 0.75rem !important;
                margin: 0.75rem 0 !important;
            }
            /* Buttons and tabs */
            .phase-btn, .spec-tab {
                font-size: 0.6875rem !important;
                padding: 0.5rem 0.75rem !important;
                min-height: 44px !important;
            }
            /* Tables - ensure horizontal scroll */
            .overflow-x-auto {
                margin-left: -1rem !important;
                margin-right: -1rem !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
            table {
                font-size: 0.6875rem !important;
                min-width: 500px !important;
                display: table !important;
            }
            th, td {
                padding: 0.5rem !important;
                font-size: 0.625rem !important;
                white-space: nowrap !important;
                text-align: justify !important;
            }
            th {
                font-size: 0.5625rem !important;
            }
            /* Talent trees and macros */
            .talent-tree {
                font-size: 0.5625rem !important;
                padding: 0.625rem !important;
                line-height: 1.3 !important;
                overflow-x: auto !important;
            }
            footer {
                padding: 1rem !important;
                font-size: 0.625rem !important;
            }
        }
        @media (max-width: 479px) {
            body {
                padding: 0.5rem !important;
                font-size: 0.6875rem !important;
            }
            header {
                padding: 0.75rem !important;
            }
            .ascii-logo {
                font-size: 5.5px !important;
            }
            aside {
                padding: 0.75rem !important;
            }
            .class-list li {
                font-size: 0.75rem !important;
                min-height: 44px !important;
                padding-left: 0.625rem !important;
            }
            main {
                padding: 0.75rem !important;
            }
            .overflow-x-auto {
                margin-left: -0.75rem !important;
                margin-right: -0.75rem !important;
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }
            table {
                min-width: 450px !important;
            }
            th, td {
                padding: 0.375rem !important;
                font-size: 0.5625rem !important;
            }
            th {
                font-size: 0.5rem !important;
            }
            .talent-tree {
                font-size: 0.5rem !important;
                padding: 0.5rem !important;
            }
            .phase-btn, .spec-tab {
                font-size: 0.625rem !important;
                padding: 0.375rem 0.625rem !important;
            }
            .command-line {
                font-size: 0.625rem !important;
            }
            h2 {
                font-size: 0.875rem !important;
            }
            h3 {
                font-size: 0.75rem !important;
            }
            .meta-info {
                font-size: 0.625rem !important;
                padding: 0.5rem 0.625rem !important;
            }
        }
        /* ===== ITEM QUALITY COLORS ===== */
        .item-quality-rare { color: #0070dd; }
        .item-quality-rare a {
            color: #0070dd !important;
            text-decoration: none;
            border-bottom: 1px dotted #0070dd;
            transition: all 0.2s ease;
        }
        .item-quality-rare a:hover {
            color: #ffffff !important;
            border-bottom-color: #ffffff;
        }
        .item-quality-epic { color: #a335ee; }
        .item-quality-epic a {
            color: #a335ee !important;
            text-decoration: none;
            border-bottom: 1px dotted #a335ee;
            transition: all 0.2s ease;
        }
        .item-quality-epic a:hover {
            color: #ffffff !important;
            border-bottom-color: #ffffff;
        }
        .item-quality-legendary { color: #ff8000; }
        .item-quality-legendary a {
            color: #ff8000 !important;
            text-decoration: none;
            border-bottom: 1px dotted #ff8000;
            transition: all 0.2s ease;
        }
        .item-quality-legendary a:hover {
            color: #ffffff !important;
            border-bottom-color: #ffffff;
        }
        /* ===== WOWHEAD TOOLTIP OVERRIDES ===== */
        .wowhead-tooltip {
            background: #222222 !important;
            border: 1px solid #ffffff !important;
            font-family: 'IBM Plex Mono', monospace !important;
            color: #ffffff !important;
            font-size: 12px !important;
        }
        .wowhead-tooltip .q0, .wowhead-tooltip .q { color: #9d9d9d !important; }
        .wowhead-tooltip .q1 { color: #ffffff !important; }
        .wowhead-tooltip .q2 { color: #1eff00 !important; }
        .wowhead-tooltip .q3 { color: #0070dd !important; }
        .wowhead-tooltip .q4 { color: #a335ee !important; }
        .wowhead-tooltip .q5 { color: #ff8000 !important; }
        .wowhead-tooltip table { background: #222222 !important; border-color: #ffffff !important; }
    </style>
</head>
<body class="bg-terminal-bg text-terminal-text font-mono leading-relaxed p-5 max-w-screen-xl mx-auto text-sm md:p-3 md:text-xs sm:p-2 sm:text-[11px]">
    <header class="border-2 border-terminal-text p-5 mb-5 md:border md:p-4 md:mb-4 sm:p-3 sm:mb-3">
        <div class="ascii-logo text-[10px] leading-[1.15] text-terminal-text mb-3 md:text-[7px] md:mb-2.5 sm:text-[5.5px] sm:leading-[1.1] sm:mb-2">  _____ ____   ____   _        _
 |_   _| __ ) / ___| | |___  _| |_
   | | |  _ \| |     | __\ \/ / __|
   | | | |_) | |  _ _| |_ >  <| |_
   |_| |____/ \___(_)\__ /_/\_\\__|</div>
        <div class="text-terminal-dim text-xs mb-0 md:text-[11px] sm:text-[10px]">// A Burning Crusade PvE Database</div>
    </header>
    <div class="grid grid-cols-[250px_1fr] gap-5 mb-5 md:grid-cols-1 md:gap-4 md:mb-4 sm:gap-3 sm:mb-3">
        <aside class="border border-terminal-text p-4 h-fit md:mb-0 md:p-4 sm:p-3">
            <h3 class="text-terminal-accent text-sm mb-3 uppercase md:text-[13px] md:mb-2.5 sm:text-xs sm:mb-2">▼ CLASS SELECT</h3>
            <ul class="class-list list-none">
                <li class="active py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#warrior" class="nav-link block w-full text-inherit no-underline" data-class="warrior">[ WARRIOR ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#paladin" class="nav-link block w-full text-inherit no-underline" data-class="paladin">[ PALADIN ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#hunter" class="nav-link block w-full text-inherit no-underline" data-class="hunter">[ HUNTER ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#rogue" class="nav-link block w-full text-inherit no-underline" data-class="rogue">[ ROGUE ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#priest" class="nav-link block w-full text-inherit no-underline" data-class="priest">[ PRIEST ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#shaman" class="nav-link block w-full text-inherit no-underline" data-class="shaman">[ SHAMAN ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#mage" class="nav-link block w-full text-inherit no-underline" data-class="mage">[ MAGE ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#warlock" class="nav-link block w-full text-inherit no-underline" data-class="warlock">[ WARLOCK ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#druid" class="nav-link block w-full text-inherit no-underline" data-class="druid">[ DRUID ]</a></li>
            </ul>
            <h3 class="text-terminal-accent text-sm mb-3 mt-5 uppercase md:text-[13px] md:mb-2.5 md:mt-4 sm:text-xs sm:mb-2 sm:mt-3">&#9660; MISC</h3>
            <ul class="class-list list-none">
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#recipes" class="nav-link block w-full text-inherit no-underline" data-view="recipes">[ RECIPES ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#raids" class="nav-link block w-full text-inherit no-underline" data-view="raids">[ RAIDS ]</a></li>
                <li class="py-2 pl-2.5 cursor-pointer text-terminal-text select-none md:py-2.5 md:pl-3 md:pr-2 md:text-[13px] md:min-h-[48px] md:flex md:items-center sm:py-2 sm:pl-2.5 sm:text-xs sm:min-h-[44px]"><a href="#preraid" class="nav-link block w-full text-inherit no-underline" data-view="preraid">[ RAID-READY ]</a></li>
            </ul>
        </aside>
        <main id="main-content" class="border border-terminal-text p-5 md:p-4 sm:p-3"></main>
    </div>
    <footer class="border border-terminal-text p-4 text-center text-[11px] text-terminal-dim mt-5 md:p-4 md:text-[10px] md:mt-4 sm:p-3 sm:text-[9px] sm:mt-3">
        <div>TBC.TXT // PvE Database</div>
        <div class="mt-1.5 sm:mt-1">NOT affiliated with Blizzard Entertainment // Community Project</div>
        <div class="mt-2 sm:mt-1.5"><a href="#" onclick="renderApiDocs(); return false;" class="text-terminal-accent hover:text-terminal-text underline">[ API Documentation ]</a></div>
    </footer>
    <script>
console.log('[TBC.TXT] Script loaded - v3');
// ===== GLOBAL DATA (loaded from JSON) =====
// API base URL - use local server in dev, production API otherwise
const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:8080'
    : 'https://api.tbctxt.io';

let itemIds = {};
let classData = {};
let recipesData = {};
let raidsData = {};
let enchantSpellIds = {};
let talentSpellIds = {};
let questIds = {};
let itemStats = {}; // Pre-computed item stats from Wowhead
let currentClass = 'warrior';
let currentSpec = null;
let currentPhase = 4;
let currentRaid = 'karazhan';
let currentRaidPhase = 'phase1';
let currentProfession = 'blacksmithing';
const FADE_TRANSITION_MS = 200;
function showLoading() {
    document.getElementById('main-content').innerHTML = `
        <div class="text-terminal-dim text-center py-10">
            <div class="text-terminal-accent mb-2">[ LOADING DATA... ]</div>
            <div class="text-xs">Fetching class data, items, and raid info</div>
        </div>
    `;
}
async function loadAllData() {
    showLoading();
    async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to load ${url}: ${res.status}`);
        return res.json();
    }
    try {
        const [items, classes, recipes, raids, reference, stats] = await Promise.all([
            fetchJSON('data/itemIds.json'),
            fetchJSON('data/classData.json'),
            fetchJSON('data/recipesData.json'),
            fetchJSON('data/raidsData.json'),
            fetchJSON('data/referenceData.json'),
            fetchJSON('data/itemStats.json')
        ]);
        itemIds = items;
        classData = classes;
        recipesData = recipes;
        raidsData = raids;
        enchantSpellIds = reference.enchantSpellIds;
        talentSpellIds = reference.talentSpellIds;
        questIds = reference.questIds;
        itemStats = stats;
        console.log('Data loaded:', {
            items: Object.keys(itemIds).length,
            classes: Object.keys(classData).length,
            professions: Object.keys(recipesData).length,
            raidPhases: Object.keys(raidsData).length,
            itemStats: Object.keys(itemStats).length
        });
        // Initialize the app
        initClassSelector();
        if (!window.location.hash) renderClassContent('warrior');
    } catch (error) {
        console.error('Failed to load data:', error);
        document.getElementById('main-content').innerHTML = `
            <div class="text-red-400 text-center py-10">
                <div class="mb-2">[ ERROR LOADING DATA ]</div>
                <div class="text-xs text-terminal-dim">${error.message}</div>
                <div class="text-xs text-terminal-dim mt-2">Check browser console for details (F12)</div>
            </div>
        `;
    }
}
function stripPriorityLabel(itemName) {
    return itemName.replace(/\s*\((BEST|RECOMMENDED|GOOD|OPTION|ALTERNATIVE|EASY|HARD)\)\s*$/i, '').trim();
}
function getPriorityLabel(itemName) {
    const match = itemName.match(/\((BEST|RECOMMENDED|GOOD|OPTION|ALTERNATIVE|EASY|HARD)\)\s*$/i);
    return match ? match[1].toUpperCase() : null;
}
function getPriorityBadge(label) {
    if (!label) return '';
    const badgeMap = {
        'BEST': { text: 'PRIORITY', class: 'text-red-400' },
        'RECOMMENDED': { text: 'GOOD', class: 'text-yellow-400' },
        'GOOD': { text: 'GOOD', class: 'text-yellow-400' },
        'OPTION': { text: 'OPTIONAL', class: 'text-green-400' },
        'ALTERNATIVE': { text: 'OPTIONAL', class: 'text-green-400' },
        'EASY': { text: 'EASY', class: 'text-blue-400' },
        'HARD': { text: 'HARD', class: 'text-purple-400' }
    };
    const badge = badgeMap[label];
    if (!badge) return '';
    return `<span class="ml-2 text-[10px] font-semibold ${badge.class}">[${badge.text}]</span>`;
}
function getItemId(itemName) {
    const cleanName = stripPriorityLabel(itemName);
    return itemIds[cleanName.toLowerCase()] || null;
}
function getItemQuality(itemName) {
    const cleanName = stripPriorityLabel(itemName);
    const name = cleanName.toLowerCase();
    // Legendary items
    const legendaryItems = ['warglaive of azzinoth', 'thori\'al', 'sulfuras'];
    if (legendaryItems.some(leg => name.includes(leg))) return 'legendary';
    // Rare (blue) items - mostly pre-raid dungeon drops, badges, some crafted
    const rareKeywords = [
        'badge of justice',
        'badge of tenacity',
        'vindicator\'s',
        'stalker\'s',
        'savage',
        'general\'s',
        'marshal\'s',
        'lieutenant commander\'s',
        'champion\'s',
        'centurion\'s',
        'wastewalker',
        'overlord\'s',
        'doomplate',
        'adamantine',
        'natasha\'s',
        'bloodlust brooch',
        'choker of vile intent',
        'continuum blade',
        'starlight gauntlets',
        'idol of the wild',
        'midnight legguards',
        'clefthoof',
        'flesh handler\'s',
        'deathforge',
        'girdle of the deathdealer',
        'scaled greaves',
        'terokk\'s',
        'boots of righteous fortitude',
        'ring of cryptic dreams',
        'ashyen\'s',
        'andormu\'s',
        'shatter-bound',
        'time-shifted',
        'phoenix-wing'
    ];
    // Check if it's a known epic crafted item
    const epicCraftedKeywords = [
        'primalstrike',
        'earthwarden',
        'lionheart',
        'black felsteel',
        'fel leather',
        'windhawk',
        'ragesteel',
        'khorium',
        'felfury',
        'twisting nether',
        'battlecast',
        'spellstrike',
        'whitemend',
        'primal mooncloth'
    ];
    if (epicCraftedKeywords.some(keyword => name.includes(keyword))) return 'epic';
    if (rareKeywords.some(keyword => name.includes(keyword))) return 'rare';
    // Default to epic for raid items
    return 'epic';
}
function processItemLinks() {
    if (typeof $WowheadPower !== 'undefined') {
        $WowheadPower.refreshLinks();
    }
}
// Helper function to generate item cell HTML (reduces duplication)
// Spell IDs for enchants (TBC wowhead uses spells, not items for enchants)
function getEnchantSpellId(itemName) {
    const cleanName = stripPriorityLabel(itemName).toLowerCase();
    return enchantSpellIds[cleanName] || null;
}
function getTalentSpellId(talentName) {
    const cleanName = talentName.toLowerCase().trim().replace(/\\'/g, "'");
    return talentSpellIds[cleanName] || null;
}
function getQuestId(questName) {
    const cleanName = questName.toLowerCase().trim().replace(/\\'/g, "'");
    return questIds[cleanName] || null;
}
function getQuestId(questName) {
    const cleanName = questName.toLowerCase().trim().replace(/\\'/g, "'");
    return questIds[cleanName] || null;
}
function getTalentSpellId(talentName) {
    // Handle escaped apostrophes from the data (e.g., "Nature\'s Grace" -> "nature's grace")
    const cleanName = talentName.toLowerCase().trim().replace(/\\'/g, "'");
    return talentSpellIds[cleanName] || null;
}
function getEnchantSpellId(itemName) {
    const cleanName = stripPriorityLabel(itemName).toLowerCase();
    return enchantSpellIds[cleanName] || null;
}
function generateItemCell(itemName) {
    if (itemName.includes(' / ')) {
        return itemName.split(' / ').map(item => {
            const trimmedItem = item.trim();
            const quality = getItemQuality(trimmedItem);
            const displayName = stripPriorityLabel(trimmedItem);
            const priorityLabel = getPriorityLabel(trimmedItem);
            const priorityBadge = (currentPhase === 0) ? getPriorityBadge(priorityLabel) : '';
            const itemId = getItemId(trimmedItem);
            const spellId = getEnchantSpellId(trimmedItem);
            // Use spell ID for enchants, item ID for items, otherwise plain text
            let link;
            if (spellId) {
                link = `<a href="https://tbc.wowhead.com/spell=${spellId}" data-wowhead="spell=${spellId}">${displayName}</a>`;
            } else if (itemId) {
                link = `<a href="https://tbc.wowhead.com/item=${itemId}" data-wowhead="item=${itemId}">${displayName}</a>`;
            } else {
                link = displayName;
            }
            return `<span class="item-quality-${quality}">${link}${priorityBadge}</span>`;
        }).join(' / ');
    }
    const quality = getItemQuality(itemName);
    const displayName = stripPriorityLabel(itemName);
    const priorityLabel = getPriorityLabel(itemName);
    const priorityBadge = (currentPhase === 0) ? getPriorityBadge(priorityLabel) : '';
    const itemId = getItemId(itemName);
    const spellId = getEnchantSpellId(itemName);
    // Use spell ID for enchants, item ID for items, otherwise plain text
    let link;
    if (spellId) {
        link = `<a href="https://tbc.wowhead.com/spell=${spellId}" data-wowhead="spell=${spellId}">${displayName}</a>`;
    } else if (itemId) {
        link = `<a href="https://tbc.wowhead.com/item=${itemId}" data-wowhead="item=${itemId}">${displayName}</a>`;
    } else {
        link = displayName;
    }
    return `<span class="item-quality-${quality}">${link}${priorityBadge}</span>`;
}
// Helper function to process source text and create wowhead NPC/quest links
function generateSourceCell(source) {
    // NPC map for boss linking
    const npcMap = {
        // Karazhan
        'Attumen the Huntsman': 16151, 'Moroes': 15687, 'Maiden of Virtue': 16457,
        'Opera Event': 0, 'The Curator': 15691, 'Shade of Aran': 16524,
        'Terestian Illhoof': 15688, 'Netherspite': 15689, 'Chess Event': 0,
        'Prince Malchezaar': 15690, 'Nightbane': 17225,
        // Gruul's Lair
        'High King Maulgar': 18831, 'Gruul the Dragonkiller': 19044,
        // Magtheridon's Lair
        'Magtheridon': 17257,
        // Serpentshrine Cavern
        'Hydross the Unstable': 21216, 'The Lurker Below': 21217,
        'Leotheras the Blind': 21215, 'Fathom-Lord Karathress': 21214,
        'Morogrim Tidewalker': 21213, 'Lady Vashj': 21212,
        // Tempest Keep
        'Al\'ar': 19514, 'Void Reaver': 19516, 'High Astromancer Solarian': 18805,
        'Kael\'thas Sunstrider': 19622,
        // Hyjal Summit
        'Rage Winterchill': 17767, 'Anetheron': 17808, 'Kaz\'rogal': 17888,
        'Azgalor': 17842, 'Archimonde': 17968,
        // Black Temple
        'High Warlord Naj\'entus': 22887, 'Supremus': 22898,
        'Shade of Akama': 22841, 'Teron Gorefiend': 22871,
        'Gurtogg Bloodboil': 22948, 'Reliquary of Souls': 22856,
        'Mother Shahraz': 22947, 'Illidari Council': 23426, 'The Illidari Council': 23426,
        'Illidan Stormrage': 22917,
        // Zul'Aman
        'Akil\'zon': 23574, 'Nalorakk': 23576, 'Jan\'alai': 23578,
        'Halazzi': 23577, 'Hex Lord Malacrass': 24239, 'Zul\'jin': 23863,
        // World Bosses
        'Doom-Lord Kazzak': 18728, 'Doomwalker': 17711,
        // Sunwell Plateau
        'Kalecgos': 24850, 'Brutallus': 24882, 'Felmyst': 25038,
        'Eredar Twins': 25166, 'M\'uru': 25741, 'Kil\'jaeden': 25315,
        // Dungeon Bosses
        'Epoch Hunter': 18096, 'Quagmirran': 17942, 'The Black Stalker': 17882,
        'Avatar of the Martyred': 18478, 'Exarch Maladaar': 18373,
        'Talon King Ikiss': 18473, 'Harbinger Skyriss': 20912,
        'Warp Splinter': 17977, 'Aeonus': 17881, 'Blackheart the Inciter': 18667,
        'Temporus': 17880, 'Warlord Kalithresh': 17798, 'Keli\'dan the Breaker': 17377,
        'Warchief Kargath Bladefist': 16808, 'Pathaleon the Calculator': 19220,
        'Pandemonius': 18341, 'Tavarok': 18343, 'Ambassador Hellmaw': 18731,
        'Murmur': 18708, 'Shirrak the Dead Watcher': 18371, 'Broggok': 17380,
        'Vazruden': 17537, 'Vazruden the Herald': 17537, 'Priestess Delrissa': 24560,
        'Chrono Lord Deja': 17879, 'Omor the Unscarred': 17308,
        'Commander Sarannis': 17976, 'Nexus-Prince Shaffar': 18344,
        'Captain Skarloc': 17862, 'Rokmar the Crackler': 17991,
        'Warbringer O\'mrogg': 16809, 'Terokk': 21838, 'Yor': 22930,
        'Dalliah the Doomsayer': 20885, 'Laj': 17980,
        'Nethermancer Sepethrea': 19221, 'High Botanist Freywinn': 17975,
        'Gezzarak the Huntress': 23163,
        // More dungeon bosses
        'Hungerfen': 17770, 'Ghaz\'an': 18105, 'Anzu': 23035,
        'Lieutenant Drake': 17848, 'Mechano-Lord Capacitus': 19219,
        'Mekgineer Steamrigger': 17796, 'Mennu the Betrayer': 17941,
        'Grand Warlock Nethekurse': 16807, 'Grandmaster Vorpil': 18732,
        'Darkweaver Syth': 18472, 'Zereketh the Unbound': 20870,
        'Selin Fireheart': 24723, 'The Maker': 17381,
        'Wrath-Scryer Soccothrates': 20886,
        // World bosses / rare spawns
        'Gurok the Usurper': 18062, 'Ar\'kelos the Guardian': 20798,
        'Gava\'xi': 18298, 'Coren Direbrew': 23872,
        // Classic raids (for references)
        'C\'Thun': 15727, 'Emperor Vek\'nilash': 15275, 'Nefarian': 11583,
        'Sapphiron': 15989, 'Kel\'Thuzad': 15990,
        // Naxxramas
        'Patchwerk': 16028, 'Grobbulus': 15931, 'Gluth': 15932,
        // Karazhan extras
        'Echo of Medivh': 16816, 'Curator': 15691,
        // Vendors
        'G\'eras': 19321
    };
    // Patterns for non-boss sources (don't need NPC linking)
    const professionSources = ['Blacksmithing', 'Leatherworking', 'Tailoring', 'Jewelcrafting', 'Engineering', 'Alchemy'];
    const pvpSources = ['Honor', 'Honor Points', 'Arena', 'Arena Points'];
    const otherSources = ['BoE World Drop', 'BoE', 'World Drop', 'Crafted', 'N/A', 'Various', 'Vendor', 'PvP'];
    // Extract display text - strip zone/instance info from "Boss - Zone" format
    let displayText = source;
    let bossName = null;
    let questName = null;
    // Pattern: "Boss - Zone" or "Boss— Zone" or "Boss - (H) Zone" -> extract just the boss name
    // Handles both hyphens (-) and em-dashes (—)
    const bossZoneMatch = source.match(/^(.+?)\s*[-—]\s*\(?H?\)?\s*(Karazhan|Gruul's Lair|Magtheridon's Lair|Serpentshrine Cavern|Tempest Keep|Hyjal Summit|Black Temple|Zul'Aman|Sunwell Plateau|The Blood Furnace|Blood Furnace|The Slave Pens|Slave Pens|The Underbog|Underbog|The Steamvault|Steamvault|The Botanica|Botanica|The Mechanar|Mechanar|The Arcatraz|Arcatraz|Shadow Labyrinth|Sethekk Halls|Auchenai Crypts|Auchindoun|Mana.?Tombs|Old Hillsbrad Foothills|The Black Morass|Black Morass|The Shattered Halls|Shattered Halls|Hellfire Ramparts|Ramparts|Magister's Terrace|Magisters' Terrace|Terokkar Forest|Netherstorm|Nagrand|Naxxramas|Caverns of Time|Blades? Edge Mountains|Shadowmoon Valley|Hellfire Peninsula|Tanaris|AQ40|Blackwing Lair|Stratholme|Blackrock Depths|World Boss)$/i);
    if (bossZoneMatch) {
        displayText = bossZoneMatch[1].trim();
        bossName = displayText;
    }
    // Pattern: "(H)Boss-Zone" or "(H) Boss - Zone" or "Boss— HeroicZone" or "Bossin HeroicZone" for heroic dungeons
    const heroicMatch = source.match(/^\(H\)\s*(.+?)[-–—]\s*(.+)$/) ||
                        source.match(/^(.+?)[-—]\s*[Hh]eroic\s*(.+)$/) ||
                        source.match(/^(.+?)in\s*[Hh]eroic(.+)$/);
    if (heroicMatch) {
        displayText = heroicMatch[1].trim();
        bossName = displayText;
    }
    // Pattern: "Boss—Zone" or "Boss-Zone" (no space) for dungeons -> extract boss name
    const bossZoneNoSpaceMatch = source.match(/^([A-Z][^-—]+)[-—]([A-Z].+)$/);
    if (!bossName && bossZoneNoSpaceMatch && !source.includes(' - ') && !source.includes(' — ')) {
        const potentialBoss = bossZoneNoSpaceMatch[1].trim();
        if (npcMap[potentialBoss] || npcMap[potentialBoss.replace(/'/g, "\\'")] ) {
            displayText = potentialBoss;
            bossName = potentialBoss;
        }
    }
    // Pattern: "Boss1,Boss2, orBoss3—Zone" -> extract first boss name
    // Also handles case where bossZoneMatch succeeded but gave us multiple bosses
    if (bossName && bossName.includes(',')) {
        const firstBoss = bossName.split(',')[0].trim();
        if (npcMap[firstBoss]) {
            displayText = firstBoss;
            bossName = firstBoss;
        }
    }
    const multiBossMatch = source.match(/^([A-Z][^,]+),.*[-—](.+)$/);
    if (!bossName && multiBossMatch) {
        const firstBoss = multiBossMatch[1].trim();
        if (npcMap[firstBoss]) {
            displayText = firstBoss;
            bossName = firstBoss;
        }
    }
    // Pattern: Any source containing "Badge of Justice" with a number -> show badge count
    const badgeMatch = source.match(/(\d+)\s*x?\s*-?\s*Badge[s]?\s*(of\s*Justice)?/i);
    if (badgeMatch || source.toLowerCase().includes('badge of justice')) {
        const count = badgeMatch ? badgeMatch[1] : '';
        const displayText = count ? `${count} Badges` : 'Badge Vendor';
        return `<a href="https://tbc.wowhead.com/item=29434" data-wowhead="item=29434" class="underline hover:text-terminal-text">${displayText}</a>`;
    }
    // Pattern: "Justice Vendor" -> badge vendor
    if (source.toLowerCase().includes('justice vendor')) {
        const countMatch = source.match(/(\d+)/);
        const count = countMatch ? countMatch[1] : '';
        const displayText = count ? `${count} Badges` : 'Badge Vendor';
        return `<a href="https://tbc.wowhead.com/item=29434" data-wowhead="item=29434" class="underline hover:text-terminal-text">${displayText}</a>`;
    }
    // Pattern: "G'eras- X xBadge" -> show badge count
    const gerasBadgeMatch = source.match(/G'eras\s*-?\s*(\d+)\s*x?\s*Badge/i);
    if (gerasBadgeMatch) {
        return `<a href="https://tbc.wowhead.com/item=29434" data-wowhead="item=29434" class="underline hover:text-terminal-text">${gerasBadgeMatch[1]} Badges</a>`;
    }
    // Pattern: "Exalted - Faction" or "Faction - Exalted/Revered/Honored" (handles both - and —)
    const repMatch = source.match(/^(Exalted|Revered|Honored|Friendly)\s*[-—]\s*(.+)$/i) || source.match(/^(.+?)\s*[-—]\s*(Exalted|Revered|Honored|Friendly)$/i);
    if (repMatch) {
        const faction = repMatch[1].match(/Exalted|Revered|Honored|Friendly/i) ? repMatch[2] : repMatch[1];
        const standing = repMatch[1].match(/Exalted|Revered|Honored|Friendly/i) ? repMatch[1] : repMatch[2];
        return `${faction} (${standing})`;
    }
    // Pattern: "The Aldor- Revered" etc (handles both - and —)
    const factionRepMatch = source.match(/^(The Aldor|The Scryers|Lower City|Keepers of Time|The Sha'tar|Cenarion Expedition|Honor Hold|Thrallmar|The Violet Eye|The Scale of the Sands|Ashtongue Deathsworn|The Consortium|Kurenai|The Mag'har)\s*[-—]?\s*(Exalted|Revered|Honored|Friendly)$/i);
    if (factionRepMatch) {
        return `${factionRepMatch[1]} (${factionRepMatch[2]})`;
    }
    // Profession sources - just return the profession name (no link)
    // Handles: "Blacksmithing", "Spellfire Tailoring", "Mooncloth Tailoring", etc.
    const professionMatch = professionSources.find(p => source.toLowerCase().includes(p.toLowerCase()));
    if (professionMatch) {
        // Handle profession specializations: "Spellfire Tailoring", "Mooncloth Tailoring", etc.
        // Also handle "Item—Tailoring" format
        const cleanSource = source.split('—')[0].trim();
        return cleanSource;
    }
    // PvP sources
    if (pvpSources.some(p => source.toLowerCase() === p.toLowerCase() || source.toLowerCase().includes(p.toLowerCase()))) {
        return source;
    }
    // Other simple sources
    if (otherSources.some(o => source.toLowerCase().includes(o.toLowerCase()))) {
        return source;
    }
    // Pattern: "Trash Mobs in - Zone" or "Trash mobs in - Zone"
    const trashMatch = source.match(/Trash\s*[Mm]obs?\s*in\s*-?\s*(.+)/i);
    if (trashMatch) {
        return `Trash (${trashMatch[1]})`;
    }
    // Pattern: "Xrd Timed Chest - Zul'Aman"
    const timedChestMatch = source.match(/(\d+\w*)\s*Timed\s*Chest/i);
    if (timedChestMatch) {
        return `${timedChestMatch[1]} Timed Chest`;
    }
    // Pattern: "Darkmoon Furies Deck" etc
    if (source.includes('Darkmoon') && source.includes('Deck')) {
        return source;
    }
    // Pattern: "Zul'Aman" - timed chest rewards
    if (source === 'Zul\'Aman' || source === 'Zul\\\'Aman') {
        return `<a href="https://tbc.wowhead.com/zone=3805" data-wowhead="zone=3805" class="underline hover:text-terminal-text">Zul\'Aman</a>`;
    }
    // Quest handling - check questIds FIRST before boss name matching
    // This prevents "Teron Gorefiend, I am..." from matching the boss "Teron Gorefiend"
    const questId = getQuestId(source);
    if (questId) {
        return `<a href="https://tbc.wowhead.com/quest=${questId}" data-wowhead="quest=${questId}" class="underline hover:text-terminal-text">${source}</a>`;
    }
    // Handle quest sources with "/" separator (multiple quest names)
    if (source.includes('/')) {
        const firstQuest = source.split('/')[0].trim();
        const questIdFirst = getQuestId(firstQuest);
        if (questIdFirst) {
            return `<a href="https://tbc.wowhead.com/quest=${questIdFirst}" data-wowhead="quest=${questIdFirst}" class="underline hover:text-terminal-text">${firstQuest}</a>`;
        }
    }
    // Check if source contains any known quest name (for contaminated strings)
    const sourceLower = source.toLowerCase().replace(/\\'/g, "'");
    for (const [questName, qId] of Object.entries(questIds)) {
        if (sourceLower.includes(questName)) {
            const displayQuestName = questName.charAt(0).toUpperCase() + questName.slice(1);
            return `<a href="https://tbc.wowhead.com/quest=${qId}" data-wowhead="quest=${qId}" class="underline hover:text-terminal-text">${displayQuestName}</a>`;
        }
    }
    // If we identified a boss name, try to link it
    if (bossName) {
        const npcId = npcMap[bossName] || npcMap[bossName.replace(/'/g, "\\'")] || 0;
        if (npcId > 0) {
            return `<a href="https://tbc.wowhead.com/npc=${npcId}" class="underline hover:text-terminal-text">${bossName}</a>`;
        }
        // Check if boss name is in npcMap with different quote escaping
        for (const [npcName, id] of Object.entries(npcMap)) {
            if (npcName.toLowerCase() === bossName.toLowerCase() && id > 0) {
                return `<a href="https://tbc.wowhead.com/npc=${id}" class="underline hover:text-terminal-text">${bossName}</a>`;
            }
        }
        return bossName;
    }
    // Check if the source contains any known NPC name directly
    // Sort by name length descending to match longer names first (e.g., "Kael'thas Sunstrider" before "Kael")
    const sortedNpcs = Object.entries(npcMap).sort((a, b) => b[0].length - a[0].length);
    for (const [npcName, npcId] of sortedNpcs) {
        if (npcId > 0) {
            // Check both with and without escaped apostrophes
            const sourceNormalized = source.replace(/\\'/g, "'");
            const npcNameNormalized = npcName.replace(/\\'/g, "'");
            if (sourceNormalized.includes(npcNameNormalized)) {
                return `<a href="https://tbc.wowhead.com/npc=${npcId}" class="underline hover:text-terminal-text">${npcNameNormalized}</a>`;
            }
        }
    }
    return displayText;
}
// Helper function to generate BIS table rows
function generateBisTable(bisData, specData) {
    // Group items by slot
    const groupedBySlot = {};
    bisData.forEach(row => {
        const slot = row[0];
        if (!groupedBySlot[slot]) {
            groupedBySlot[slot] = [];
        }
        groupedBySlot[slot].push({item: row[1], source: row[2]});
    });
    // Get enchants from specData
    const enchants = specData.enchants || {};
    // Mapping between bis slot names and enchant slot names
    const slotMapping = {
        'HELM': ['Head', 'Helm'],
        'NECK': ['Neck'],
        'SHOULDER': ['Shoulders', 'Shoulder'],
        'CLOAK': ['Back', 'Cloak'],
        'CHEST': ['Chest'],
        'BRACER': ['Bracers', 'Bracer', 'Wrist', 'Wrists'],
        'GLOVES': ['Gloves', 'Hands'],
        'BELT': ['Belt', 'Waist'],
        'LEGS': ['Legs'],
        'BOOTS': ['Feet', 'Feet*', 'Boots'],
        'RING': ['Finger', 'Ring', 'Rings', 'Ring (Enchanting-only)'],
        'RING 1': ['Finger', 'Ring', 'Rings', 'Ring (Enchanting-only)'],
        'RING 2': ['Finger', 'Ring', 'Rings', 'Ring (Enchanting-only)'],
        'TRINKET': ['Trinket', 'Trinkets'],
        'TRINKET 1': ['Trinket', 'Trinkets'],
        'TRINKET 2': ['Trinket', 'Trinkets'],
        'TRINKETS': ['Trinket', 'Trinkets'],
        'WEAPON': ['Weapon', 'Two-Handed Weapon', 'Main Hand Weapon', 'One-Handed Weapons', 'Melee Weapon'],
        '2-HANDER': ['Two-Handed Weapon', 'Weapon'],
        'DUAL WIELD - MH': ['Main Hand Weapon', 'One-Handed Weapons', 'Melee Weapon', 'Weapon'],
        'DUAL WIELD - OH': ['Off Hand Weapon', 'Off-Hand'],
        'MELEE WEAPON 1': ['Melee Weapon', 'Main Hand Weapon', 'Weapon'],
        'MELEE WEAPON 2': ['Melee Weapon', 'Off Hand Weapon', 'Weapon'],
        'OFF-HAND': ['Off Hand Weapon', 'Off-Hand', 'Shield'],
        'RANGED': ['Ranged Weapon'],
        'RANGED WEAPON': ['Ranged Weapon']
    };
    // Generate table rows with grouped items
    return Object.entries(groupedBySlot).map(([slot, items]) => {
        const itemsHtml = items.map(i => generateItemCell(i.item)).join('<br>');
        const sourcesHtml = items.map(i => generateSourceCell(i.source)).join('<br>');
        // Find matching enchant for this slot
        let enchantHtml = '';
        const possibleEnchantKeys = slotMapping[slot] || [slot];
        for (const possibleKey of possibleEnchantKeys) {
            const enchantKey = Object.keys(enchants).find(key =>
                key.toLowerCase() === possibleKey.toLowerCase()
            );
            if (enchantKey) {
                enchantHtml = generateItemCell(enchants[enchantKey]);
                break;
            }
        }
        if (!enchantHtml) {
            enchantHtml = '<span class="text-terminal-dim">-</span>';
        }
        return `<tr class="hover:bg-white/5 transition-colors"><td class="p-2.5 border-b border-terminal-dim whitespace-nowrap md:p-2 sm:p-1.5">${slot}</td><td class="p-2.5 border-b border-terminal-dim md:p-2 sm:p-1.5">${itemsHtml}</td><td class="p-2.5 border-b border-terminal-dim md:p-2 sm:p-1.5">${enchantHtml}</td><td class="p-2.5 border-b border-terminal-dim md:p-2 sm:p-1.5">${sourcesHtml}</td></tr>`;
    }).join('');
}
function renderRaidsContent() {
    currentClass = null;
    document.querySelectorAll('.class-list li').forEach(li => li.classList.remove('active'));
    const raidsLink = document.querySelector('.class-list li[data-view="raids"]');
    if (raidsLink) raidsLink.classList.add('active');
    const phaseData = raidsData[currentRaidPhase];
    if (!phaseData) return;
    const raidData = phaseData.raids[currentRaid];
    // Build phase buttons
    const phaseButtons = Object.entries(raidsData).map(([key, phase]) =>
        `<a href="#raids/${key}" class="raid-phase-btn ${key === currentRaidPhase ? 'bg-terminal-text text-terminal-bg' : 'bg-transparent'} border border-terminal-text text-terminal-text px-4 py-2.5 cursor-pointer font-mono text-xs transition-all select-none hover:bg-terminal-text hover:text-terminal-bg no-underline md:px-3.5 md:py-2.5 md:text-[11px] md:min-h-[48px] md:inline-flex md:items-center md:justify-center sm:px-3 sm:py-2 sm:text-[10px] sm:min-h-[44px]" data-phase="${key}">${phase.name}</a>`
    ).join('');
    // Build raid buttons for current phase
    const raidButtons = Object.entries(phaseData.raids).map(([key, raid]) =>
        `<a href="#raids/${currentRaidPhase}/${key}" class="raid-btn ${key === currentRaid ? 'bg-terminal-accent text-terminal-bg' : 'bg-transparent'} border border-terminal-accent text-terminal-accent px-3 py-2 cursor-pointer font-mono text-xs transition-all select-none hover:bg-terminal-accent hover:text-terminal-bg no-underline md:px-3 md:py-2 md:text-[11px] sm:px-2.5 sm:py-1.5 sm:text-[10px]" data-raid="${key}">${raid.name} (${raid.size})</a>`
    ).join('');
    let html = `
        <div class="command-line text-terminal-dim my-5 md:text-[11px] md:my-3 sm:text-[10px]">query: tbc_raids --phase=${currentRaidPhase} --raid=${currentRaid}</div>
        <h2 class="text-terminal-accent text-lg mb-4 uppercase tracking-wide md:text-base md:mb-3 md:tracking-wider sm:text-sm sm:tracking-tight">[ TBC RAID GUIDES ]</h2>
        <p class="text-terminal-dim text-xs mb-6 md:mb-4 sm:mb-3">Boss strategies and ability breakdowns for all TBC raids</p>
        <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ PHASE SELECTION ]</h3>
        <div class="flex flex-wrap gap-2 mb-4 md:gap-1.5 md:mb-3 sm:mb-2">${phaseButtons}</div>
        <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ RAIDS - ${phaseData.name.toUpperCase()} ]</h3>
        <div class="flex flex-wrap gap-2 mb-6 md:gap-1.5 md:mb-4 sm:mb-3">${raidButtons}</div>
    `;
    if (raidData) {
        // Raid overview section
        html += `
            <div class="border border-terminal-dim p-4 mb-6 md:p-3 md:mb-4 sm:p-2.5 sm:mb-3">
                <h3 class="text-terminal-accent text-base mb-3 md:text-sm sm:text-xs">${raidData.name}${raidData.shortName ? ` (${raidData.shortName})` : ''}</h3>
                <p class="text-terminal-dim text-xs mb-4 leading-relaxed md:text-[11px] md:mb-3 sm:text-[10px]">${raidData.description || ''}</p>
                <div class="grid grid-cols-2 gap-4 text-xs md:grid-cols-1 md:gap-2 md:text-[11px] sm:text-[10px]">
                    <div class="space-y-1.5">
                        <div><span class="text-terminal-text">Size:</span> <span class="text-terminal-dim">${raidData.size} players</span></div>
                        <div><span class="text-terminal-text">Location:</span> <span class="text-terminal-dim">${raidData.location}</span></div>
                        <div><span class="text-terminal-text">Attunement:</span> <span class="text-terminal-dim">${raidData.attunement}</span></div>
                        ${raidData.tierTokens ? `<div><span class="text-terminal-text">Tier Tokens:</span> <span class="text-terminal-dim">${raidData.tierTokens}</span></div>` : ''}
                    </div>
                </div>
            </div>
        `;

        // Recommended composition section
        if (raidData.recommendedComposition) {
            const comp = raidData.recommendedComposition;
            html += `
                <div class="border border-terminal-accent border-opacity-30 p-4 mb-6 md:p-3 md:mb-4 sm:p-2.5 sm:mb-3">
                    <h4 class="text-terminal-accent text-sm mb-3 uppercase md:text-xs sm:text-[11px]">// Recommended Raid Composition</h4>
                    <div class="flex flex-wrap gap-4 mb-3 text-xs md:gap-3 md:text-[11px] sm:gap-2 sm:text-[10px]">
                        <div class="bg-blue-900 bg-opacity-30 px-3 py-1.5 border border-blue-500 border-opacity-50">
                            <span class="text-blue-400">TANKS:</span> <span class="text-terminal-text">${comp.tanks}</span>
                        </div>
                        <div class="bg-green-900 bg-opacity-30 px-3 py-1.5 border border-green-500 border-opacity-50">
                            <span class="text-green-400">HEALERS:</span> <span class="text-terminal-text">${comp.healers}</span>
                        </div>
                        <div class="bg-red-900 bg-opacity-30 px-3 py-1.5 border border-red-500 border-opacity-50">
                            <span class="text-red-400">DPS:</span> <span class="text-terminal-text">${comp.dps}</span>
                        </div>
                    </div>
                    ${comp.notes ? `<p class="text-terminal-dim text-xs leading-relaxed md:text-[11px] sm:text-[10px]">${comp.notes}</p>` : ''}
                </div>
            `;
        }

        // Minimum gear requirements section
        if (raidData.minimumGear) {
            const gear = raidData.minimumGear;
            html += `
                <div class="border border-yellow-500 border-opacity-30 p-4 mb-6 md:p-3 md:mb-4 sm:p-2.5 sm:mb-3">
                    <h4 class="text-yellow-400 text-sm mb-3 uppercase md:text-xs sm:text-[11px]">// Minimum Gear Requirements</h4>
                    <div class="space-y-2 text-xs md:text-[11px] sm:text-[10px]">
                        ${gear.tanks ? `<div><span class="text-blue-400">Tanks:</span> <span class="text-terminal-dim">${gear.tanks}</span></div>` : ''}
                        ${gear.healers ? `<div><span class="text-green-400">Healers:</span> <span class="text-terminal-dim">${gear.healers}</span></div>` : ''}
                        ${gear.dps ? `<div><span class="text-red-400">DPS:</span> <span class="text-terminal-dim">${gear.dps}</span></div>` : ''}
                    </div>
                </div>
            `;
        }

        // Attunement steps section
        if (raidData.attunementSteps && raidData.attunementSteps.length > 0) {
            html += `
                <div class="border border-purple-500 border-opacity-30 p-4 mb-6 md:p-3 md:mb-4 sm:p-2.5 sm:mb-3">
                    <h4 class="text-purple-400 text-sm mb-3 uppercase md:text-xs sm:text-[11px]">// Attunement Guide</h4>
                    <div class="space-y-1.5 text-xs md:text-[11px] sm:text-[10px]">
                        ${raidData.attunementSteps.map(step => `<div class="text-terminal-dim">${step}</div>`).join('')}
                    </div>
                </div>
            `;
        }
        // Boss list header
        html += `<h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ BOSS ENCOUNTERS ]</h3>`;

        // Difficulty badge colors
        const difficultyColors = {
            'Easy': 'bg-green-900 border-green-500 text-green-400',
            'Medium': 'bg-yellow-900 border-yellow-500 text-yellow-400',
            'Hard': 'bg-red-900 border-red-500 text-red-400',
            'Very Hard': 'bg-purple-900 border-purple-500 text-purple-400'
        };

        for (const boss of raidData.bosses) {
            const bossLink = boss.npcId
                ? `<a href="https://tbc.wowhead.com/npc=${boss.npcId}" data-wowhead="npc=${boss.npcId}" class="text-wow-epic hover:text-terminal-text text-base md:text-sm sm:text-xs">${boss.name}</a>`
                : `<span class="text-wow-epic text-base md:text-sm sm:text-xs">${boss.name}</span>`;

            const difficultyBadge = boss.difficulty
                ? `<span class="ml-3 px-2 py-0.5 text-[10px] uppercase border bg-opacity-30 ${difficultyColors[boss.difficulty] || difficultyColors['Medium']}">${boss.difficulty}</span>`
                : '';

            html += `
                <div class="mb-6 border border-terminal-dim border-opacity-50 p-4 md:mb-4 md:p-3 sm:mb-3 sm:p-2.5">
                    <h4 class="mb-3 md:mb-2 sm:mb-1.5 flex items-center flex-wrap gap-2">${bossLink}${difficultyBadge}</h4>
                    <p class="text-terminal-dim text-xs mb-3 leading-relaxed md:text-[11px] md:mb-2 sm:text-[10px]">${boss.description}</p>
            `;

            // Phase breakdown section
            if (boss.phaseBreakdown && boss.phaseBreakdown.length > 0) {
                html += `
                    <div class="border border-cyan-500 border-opacity-30 p-3 mb-3 md:p-2.5 md:mb-2 sm:p-2">
                        <h5 class="text-cyan-400 text-xs uppercase mb-2 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Phase Breakdown</h5>
                        <div class="space-y-1.5 text-xs md:text-[11px] sm:text-[10px]">
                            ${boss.phaseBreakdown.map(phase => `<div class="text-terminal-dim">${phase}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Guest list section (for Moroes)
            if (boss.guestList && boss.guestList.length > 0) {
                html += `
                    <div class="border border-orange-500 border-opacity-30 p-3 mb-3 md:p-2.5 md:mb-2 sm:p-2">
                        <h5 class="text-orange-400 text-xs uppercase mb-2 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Possible Dinner Guests (4 spawn randomly)</h5>
                        <div class="grid grid-cols-2 gap-1.5 text-xs md:grid-cols-1 md:text-[11px] sm:text-[10px]">
                            ${boss.guestList.map(guest => `<div class="text-terminal-dim">• ${guest}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Abilities table with handling column
            if (boss.abilities && boss.abilities.length > 0) {
                html += `
                    <div class="mb-3 md:mb-2">
                        <h5 class="text-terminal-text text-xs uppercase mb-2 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Abilities</h5>
                        <div class="overflow-x-auto -mx-4 px-4 md:-mx-3 md:px-3 sm:-mx-2.5 sm:px-2.5">
                            <table class="w-full border-collapse text-xs min-w-[700px] md:text-[11px] sm:text-[10px] sm:min-w-[500px]">
                                <thead>
                                    <tr>
                                        <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px] w-[15%]">ABILITY</th>
                                        <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px] w-[35%]">DESCRIPTION</th>
                                        <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px] w-[50%]">HOW TO HANDLE</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                for (const ability of boss.abilities) {
                    const abilityLink = ability.spellId
                        ? `<a href="https://tbc.wowhead.com/spell=${ability.spellId}" data-wowhead="spell=${ability.spellId}" class="text-terminal-accent hover:text-terminal-text">${ability.name}</a>`
                        : `<span class="text-terminal-accent">${ability.name}</span>`;
                    html += `
                        <tr class="border-b border-terminal-dim border-opacity-30">
                            <td class="p-2 md:p-1.5 sm:p-1 whitespace-nowrap align-top">${abilityLink}</td>
                            <td class="p-2 text-terminal-dim md:p-1.5 sm:p-1 align-top">${ability.description}</td>
                            <td class="p-2 text-green-400 text-opacity-80 md:p-1.5 sm:p-1 align-top">${ability.handling || '-'}</td>
                        </tr>
                    `;
                }
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            // Strategy section
            if (boss.strategy) {
                html += `
                    <div class="bg-terminal-bg/50 border border-terminal-accent border-opacity-30 p-3 mb-3 md:p-2.5 md:mb-2 sm:p-2">
                        <h5 class="text-terminal-accent text-xs uppercase mb-1.5 md:text-[11px] md:mb-1 sm:text-[10px]">// Strategy</h5>
                        <p class="text-terminal-dim text-xs leading-relaxed md:text-[11px] sm:text-[10px]">${boss.strategy}</p>
                    </div>
                `;
            }

            // Common mistakes section
            if (boss.commonMistakes && boss.commonMistakes.length > 0) {
                html += `
                    <div class="border border-red-500 border-opacity-30 p-3 mb-3 md:p-2.5 md:mb-2 sm:p-2">
                        <h5 class="text-red-400 text-xs uppercase mb-2 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Common Mistakes to Avoid</h5>
                        <div class="space-y-1 text-xs md:text-[11px] sm:text-[10px]">
                            ${boss.commonMistakes.map(mistake => `<div class="text-terminal-dim">⚠ ${mistake}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Loot highlights section
            if (boss.lootHighlights && boss.lootHighlights.length > 0) {
                html += `
                    <div class="border border-wow-epic border-opacity-30 p-3 md:p-2.5 sm:p-2">
                        <h5 class="text-wow-epic text-xs uppercase mb-2 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Notable Loot</h5>
                        <div class="flex flex-wrap gap-2 text-xs md:text-[11px] sm:text-[10px]">
                            ${boss.lootHighlights.map(item => `<span class="text-terminal-dim bg-terminal-dim bg-opacity-20 px-2 py-0.5">${item}</span>`).join('')}
                        </div>
                    </div>
                `;
            }

            html += `
                </div>
            `;
        }
    }
    const mainContent = document.getElementById('main-content');
    mainContent.style.opacity = '0.3';
    setTimeout(() => {
        mainContent.innerHTML = html;
        mainContent.style.opacity = '1';
        // Add event listeners to phase buttons
        document.querySelectorAll('.raid-phase-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.ctrlKey || e.metaKey || e.button === 1) return;
                e.preventDefault();
                currentRaidPhase = btn.dataset.phase;
                const firstRaid = Object.keys(raidsData[currentRaidPhase].raids)[0];
                currentRaid = firstRaid;
                window.location.hash = `#raids/${currentRaidPhase}`;
            });
        });
        // Add event listeners to raid buttons
        document.querySelectorAll('.raid-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.ctrlKey || e.metaKey || e.button === 1) return;
                e.preventDefault();
                currentRaid = btn.dataset.raid;
                window.location.hash = `#raids/${currentRaidPhase}/${currentRaid}`;
            });
        });
        // Reinitialize wowhead tooltips
        if (typeof $WowheadPower !== 'undefined' && $WowheadPower.refreshLinks) {
            $WowheadPower.refreshLinks();
        }
    }, 200);
}
function renderRecipesContent() {
    currentClass = null; 
    document.querySelectorAll('.class-list li').forEach(li => li.classList.remove('active'));
    const recipesLink = document.querySelector('.class-list li[data-view="recipes"]');
    if (recipesLink) recipesLink.classList.add('active');
    const priorityLabels = {
        high: { text: 'PRIORITY', class: 'text-red-400' },
        medium: { text: 'GOOD', class: 'text-yellow-400' },
        low: { text: 'OPTIONAL', class: 'text-green-400' }
    };
    const profession = recipesData[currentProfession];
    if (!profession) return;
    let html = `
        <div class="command-line text-terminal-dim my-5 md:text-[11px] md:my-3 sm:text-[10px]">query: profession_recipes --profession=${currentProfession}</div>
        <h2 class="text-terminal-accent text-lg mb-4 uppercase tracking-wide md:text-base md:mb-3 md:tracking-wider sm:text-sm sm:tracking-tight">[ ${profession.title.toUpperCase()} // TBC ]</h2>
        <p class="text-terminal-dim text-xs mb-6 md:mb-4 sm:mb-3">Essential ${profession.title} recipes to prioritize for raiding and gold making</p>
        <div class="flex flex-wrap gap-2 mb-6 md:gap-1.5 md:mb-4 sm:mb-3">
            ${Object.keys(recipesData).map(prof => `<a href="#recipes/${prof}" class="profession-btn ${prof === currentProfession ? 'bg-terminal-text text-terminal-bg' : 'bg-transparent'} border border-terminal-text text-terminal-text px-4 py-2.5 cursor-pointer font-mono text-xs transition-all select-none hover:bg-terminal-text hover:text-terminal-bg no-underline md:px-3.5 md:py-2.5 md:text-[11px] md:min-h-[48px] md:inline-flex md:items-center md:justify-center sm:px-3 sm:py-2 sm:text-[10px] sm:min-h-[44px]" data-profession="${prof}">${recipesData[prof].title}</a>`).join('')}
        </div>
    `;
    for (const [catKey, category] of Object.entries(profession.categories)) {
        html += `
            <div class="mb-6 last:mb-0">
                <h4 class="text-terminal-text text-sm mb-3 md:text-xs">// ${category.name}</h4>
                <div class="overflow-x-auto -mx-5 px-5 md:-mx-4 md:px-4 sm:-mx-3 sm:px-3">
                    <table class="w-full border-collapse text-[13px] min-w-[700px] md:text-[11px] sm:text-[10px] sm:min-w-[600px]">
                        <thead>
                            <tr>
                                <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">RECIPE</th>
                                <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">SOURCE</th>
                                <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">PRIORITY</th>
                                <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">NOTES</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        for (const recipe of category.recipes) {
            const priority = priorityLabels[recipe.priority] || priorityLabels.medium;
            // Handle recipe name with tooltip - some items like head/shoulder enchants don't have craftable spell IDs
            let recipeName;
            if (recipe.itemId) {
                // Use item tooltip
                recipeName = `<a href="https://tbc.wowhead.com/item=${recipe.itemId}" data-wowhead="item=${recipe.itemId}" class="text-terminal-accent hover:text-terminal-text">${recipe.name}</a>`;
            } else if (recipe.spellId && recipe.spellId > 0) {
                // Use spell tooltip
                recipeName = `<a href="https://tbc.wowhead.com/spell=${recipe.spellId}" data-wowhead="spell=${recipe.spellId}" class="text-terminal-accent hover:text-terminal-text">${recipe.name}</a>`;
            } else {
                // No tooltip, just plain text
                recipeName = `<span class="text-terminal-accent">${recipe.name}</span>`;
            }
            html += `
                <tr class="border-b border-terminal-dim border-opacity-30 hover:bg-terminal-dim hover:bg-opacity-10">
                    <td class="p-2.5 md:p-2 sm:p-1.5">${recipeName}</td>
                    <td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">${recipe.source}</td>
                    <td class="p-2.5 md:p-2 sm:p-1.5"><span class="text-[10px] font-semibold ${priority.class}">[${priority.text}]</span></td>
                    <td class="p-2.5 text-terminal-dim italic md:p-2 sm:p-1.5">${recipe.notes}</td>
                </tr>
            `;
        }
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    const mainContent = document.getElementById('main-content');
    mainContent.style.opacity = '0.3';
    setTimeout(() => {
        mainContent.innerHTML = html;
        mainContent.style.opacity = '1';
        // Add event listeners to profession buttons
        document.querySelectorAll('.profession-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (e.ctrlKey || e.metaKey || e.button === 1) return;
                e.preventDefault();
                currentProfession = btn.dataset.profession;
                window.location.hash = `#recipes/${currentProfession}`;
            });
        });
        // Reinitialize wowhead tooltips
        if (typeof $WowheadPower !== 'undefined' && $WowheadPower.refreshLinks) {
            $WowheadPower.refreshLinks();
        }
    }, FADE_TRANSITION_MS);
}
function renderClassContent(className) {
    const data = classData[className];
    if (!data) return;
    currentClass = className;
    // Set default spec if needed
    if (!currentSpec || !data.specs[currentSpec]) {
        currentSpec = data.defaultSpec;
    }
    const specData = data.specs[currentSpec];
    if (!specData) return;
    // Validate current phase
    if (!specData.phases[currentPhase]) {
        currentPhase = Object.keys(specData.phases)[0];
    }
    const phaseData = specData.phases[currentPhase];
    // Generate UI components
    const phaseButtons = Object.keys(specData.phases)
        .map(p => `<a href="#${className}/${currentSpec}/${p}" class="phase-btn ${p == currentPhase ? 'bg-terminal-text text-terminal-bg' : 'bg-transparent'} border border-terminal-text text-terminal-text px-4 py-2.5 cursor-pointer font-mono text-xs transition-all select-none hover:bg-terminal-text hover:text-terminal-bg no-underline md:px-3.5 md:py-2.5 md:text-[11px] md:min-h-[48px] md:inline-flex md:items-center md:justify-center sm:px-3 sm:py-2 sm:text-[10px] sm:min-h-[44px]" data-phase="${p}">${specData.phases[p].name}</a>`)
        .join('');
    const bisTable = generateBisTable(phaseData.bis, specData);
    // Generate talents tree
    let talentsHtml = '';
    if (specData.talents && specData.talents.length > 0) {
        const buildsList = specData.talents.map((build, buildIdx) => {
            const buildPrefix = buildIdx === specData.talents.length - 1 ? '└──' : '├──';
            let buildHtml = `${buildPrefix} ${build.name}\n`;
            build.trees.forEach((tree, treeIdx) => {
                if (tree.talents.length === 0) return;
                const treeIndent = buildIdx === specData.talents.length - 1 ? '    ' : '│   ';
                const treePrefix = treeIdx === build.trees.length - 1 ? '└──' : '├──';
                buildHtml += `${treeIndent}${treePrefix} ${tree.name}:\n`;
                tree.talents.forEach((talent, talentIdx) => {
                    const talentIndent = treeIdx === build.trees.length - 1 ? '    ' : '│   ';
                    const talentPrefix = talentIdx === tree.talents.length - 1 ? '    └──' : '    ├──';
                    const talentSpellId = getTalentSpellId(talent.name);
                    const talentLink = talentSpellId
                        ? `<a href="https://tbc.wowhead.com/spell=${talentSpellId}" data-wowhead="spell=${talentSpellId}">${talent.name}</a>`
                        : talent.name;
                    buildHtml += `${treeIndent}${talentPrefix} ${talentLink}: ${talent.points}/${talent.max}\n`;
                });
            });
            return buildHtml;
        }).join('\n');
        talentsHtml = `
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ TALENT BUILDS ]</h3>
            <div class="talent-tree bg-terminal-bg/30 border border-terminal-dim p-4 my-4 font-mono text-xs leading-relaxed md:text-[11px] md:p-3 sm:text-[10px] sm:p-2.5" style="white-space: pre-wrap;">${buildsList}</div>
        `;
    }
    // Generate gems section
    let gemsHtml = '';
    if (specData.gems && specData.gems.length > 0) {
        const gemsList = specData.gems.map(gem => generateItemCell(gem)).join(' ');
        gemsHtml = `
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ RECOMMENDED GEMS ]</h3>
            <div class="bg-terminal-bg/30 border border-terminal-dim p-4 my-4 font-mono text-xs leading-relaxed md:text-[11px] md:p-3 sm:text-[10px] sm:p-2.5">${gemsList}</div>
        `;
    }
    // Generate macros section
    let macrosHtml = '';
    if (specData.macros && specData.macros.length > 0) {
        const macrosList = specData.macros.map(macro => {
            const escapedCode = macro.code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `
                <div class="mb-4 last:mb-0">
                    <div class="text-terminal-accent text-xs mb-1 font-semibold">${macro.name}</div>
                    <pre class="bg-terminal-bg border border-terminal-dim p-2 text-[11px] text-terminal-text overflow-x-auto select-all cursor-pointer hover:border-terminal-accent transition-colors" onclick="navigator.clipboard.writeText(this.innerText).then(() => { this.style.borderColor = '#4ade80'; setTimeout(() => this.style.borderColor = '', 500); })" title="Click to copy">${escapedCode}</pre>
                </div>`;
        }).join('');
        macrosHtml = `
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ USEFUL MACROS ]</h3>
            <div class="border border-terminal-dim p-4 my-4 md:p-3 sm:p-2.5">${macrosList}</div>
        `;
    }
    // Generate rotation section
    let rotationHtml = '';
    if (specData.rotation) {
        const rot = specData.rotation;
        // Priority list
        let priorityHtml = '';
        if (rot.priority && rot.priority.length > 0) {
            const priorityList = rot.priority.map((ability, idx) => {
                const abilityLink = ability.spellId
                    ? `<a href="https://tbc.wowhead.com/spell=${ability.spellId}" data-wowhead="spell=${ability.spellId}" class="text-terminal-accent hover:text-terminal-text">${ability.name}</a>`
                    : `<span class="text-terminal-accent">${ability.name}</span>`;
                return `<tr class="border-b border-terminal-dim border-opacity-30">
                    <td class="p-2 md:p-1.5 sm:p-1 text-terminal-accent whitespace-nowrap">${idx + 1}.</td>
                    <td class="p-2 md:p-1.5 sm:p-1 whitespace-nowrap">${abilityLink}</td>
                    <td class="p-2 text-terminal-dim md:p-1.5 sm:p-1">${ability.description}</td>
                </tr>`;
            }).join('');
            priorityHtml = `
                <h4 class="text-terminal-accent text-xs uppercase mb-2 mt-4 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Priority</h4>
                <div class="overflow-x-auto -mx-4 px-4 md:-mx-3 md:px-3 sm:-mx-2.5 sm:px-2.5">
                    <table class="w-full border-collapse text-xs min-w-[400px] md:text-[11px] sm:text-[10px]">
                        <thead><tr>
                            <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px] w-8">#</th>
                            <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px]">ABILITY</th>
                            <th class="bg-terminal-dim text-terminal-bg p-2 text-left font-semibold uppercase text-[10px] tracking-wider md:p-1.5 md:text-[9px] sm:p-1 sm:text-[8px]">USAGE</th>
                        </tr></thead>
                        <tbody>${priorityList}</tbody>
                    </table>
                </div>`;
        }
        // Opener section
        let openerHtml = '';
        if (rot.opener && rot.opener.length > 0) {
            const openerList = rot.opener.map(ability => {
                const abilityLink = ability.spellId
                    ? `<a href="https://tbc.wowhead.com/spell=${ability.spellId}" data-wowhead="spell=${ability.spellId}" class="text-terminal-accent hover:text-terminal-text">${ability.name}</a>`
                    : `<span class="text-terminal-accent">${ability.name}</span>`;
                return abilityLink;
            }).join(' → ');
            openerHtml = `
                <h4 class="text-terminal-accent text-xs uppercase mb-2 mt-4 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Opener</h4>
                <div class="bg-terminal-bg/50 border border-terminal-dim p-3 text-xs md:text-[11px] sm:text-[10px]">${openerList}</div>`;
        }
        // Cooldowns section
        let cooldownsHtml = '';
        if (rot.cooldowns && rot.cooldowns.length > 0) {
            const cdList = rot.cooldowns.map(cd => {
                const cdLink = cd.spellId
                    ? `<a href="https://tbc.wowhead.com/spell=${cd.spellId}" data-wowhead="spell=${cd.spellId}" class="text-terminal-accent hover:text-terminal-text">${cd.name}</a>`
                    : `<span class="text-terminal-accent">${cd.name}</span>`;
                return `<div class="mb-2"><span class="text-terminal-text">•</span> ${cdLink}: <span class="text-terminal-dim">${cd.description}</span></div>`;
            }).join('');
            cooldownsHtml = `
                <h4 class="text-terminal-accent text-xs uppercase mb-2 mt-4 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Cooldowns</h4>
                <div class="bg-terminal-bg/50 border border-terminal-dim p-3 text-xs md:text-[11px] sm:text-[10px]">${cdList}</div>`;
        }
        // Notes section
        let notesHtml = '';
        if (rot.notes) {
            notesHtml = `
                <h4 class="text-terminal-accent text-xs uppercase mb-2 mt-4 md:text-[11px] md:mb-1.5 sm:text-[10px]">// Notes</h4>
                <div class="bg-terminal-bg/50 border border-terminal-dim p-3 text-xs text-terminal-dim md:text-[11px] sm:text-[10px]">${rot.notes}</div>`;
        }
        rotationHtml = `
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ ROTATION ]</h3>
            <div class="border border-terminal-dim p-4 my-4 md:p-3 sm:p-2.5">
                ${rot.description ? `<p class="text-terminal-dim text-xs mb-3 md:text-[11px] sm:text-[10px]">${rot.description}</p>` : ''}
                ${priorityHtml}
                ${openerHtml}
                ${cooldownsHtml}
                ${notesHtml}
            </div>
        `;
    }
    const specs = Object.entries(data.specs)
        .map(([key, spec]) => `<a href="#${className}/${key}" class="spec-tab ${key === currentSpec ? 'border-terminal-accent text-terminal-accent' : 'border-terminal-dim'} inline-block py-2 px-3 mr-2.5 border cursor-pointer transition-all text-xs select-none hover:border-terminal-accent hover:text-terminal-accent no-underline md:py-2.5 md:px-3 md:text-[11px] md:min-h-[48px] md:inline-flex md:items-center md:mr-2 sm:py-2 sm:px-2.5 sm:text-[10px] sm:mr-1.5 sm:min-h-[44px]" data-spec="${key}">${spec.name}</a>`)
        .join('');
    const html = `
        <div class="command-line text-terminal-dim my-5 md:text-[11px] md:my-3 sm:text-[10px]">query: ${className}_pve_bis --spec=${currentSpec} --phase=${currentPhase}</div>
        <div class="mb-8 pb-5 border-b border-dashed border-terminal-dim last:border-b-0 md:mb-6 md:pb-4 sm:pb-3">
            <h2 class="text-terminal-accent text-lg mb-4 uppercase tracking-wide md:text-base md:mb-3 md:tracking-wider sm:text-sm sm:tracking-tight">[ ${data.title} // ${specData.name.toUpperCase()} PVE ]</h2>
            <p class="text-terminal-dim text-xs mb-4 md:text-[11px] sm:text-[10px]">Armor: ${data.armorType || 'Unknown'}</p>
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ SPEC SELECTION ]</h3>
            <div class="my-2.5">${specs}</div>
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ STAT PRIORITY ]</h3>
            <div class="my-2.5 text-terminal-text text-xs md:text-[11px] sm:text-[10px]">${specData.statPriority ? specData.statPriority.map((stat, i) => `<span class="${i === 0 ? 'text-terminal-accent' : ''}">${stat}</span>`).join(' > ') : '<span class="text-terminal-dim">Not specified</span>'}</div>
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ RECOMMENDED PROFESSIONS ]</h3>
            <div class="my-2.5">${data.professions ? data.professions.map(p => `[ <a href="https://tbc.wowhead.com/skill=${p.skillId}" data-wowhead="skill=${p.skillId}" class="text-terminal-text hover:text-terminal-accent">${p.name}</a> ]`).join(' ') : '<span class="text-terminal-dim">None specified</span>'}</div>
            <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ PHASE SELECTOR ]</h3>
            <div class="flex flex-wrap gap-2.5 my-4 md:gap-2 md:my-3">${phaseButtons}</div>
            <h3 id="bis-header" class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ BEST IN SLOT - ${phaseData.name} ]</h3>
            <div class="overflow-x-auto -mx-5 px-5 md:-mx-4 md:px-4 sm:-mx-3 sm:px-3">
                <table class="w-full border-collapse my-4 text-[13px] min-w-[600px] md:my-3.5 md:text-[11px] sm:my-3 sm:text-[10px] sm:min-w-[500px]">
                    <thead><tr><th class="bg-terminal-dim text-terminal-bg p-2.5 text-justify font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px] sm:tracking-wide">SLOT</th><th class="bg-terminal-dim text-terminal-bg p-2.5 text-justify font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px] sm:tracking-wide">ITEM</th><th class="bg-terminal-dim text-terminal-bg p-2.5 text-justify font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px] sm:tracking-wide">ENCHANT</th><th class="bg-terminal-dim text-terminal-bg p-2.5 text-justify font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px] sm:tracking-wide">SOURCE</th></tr></thead>
                    <tbody id="bis-table">${bisTable}</tbody>
                </table>
            </div>
            ${gemsHtml}
            ${rotationHtml}
            ${macrosHtml}
            ${talentsHtml}
        </div>
    `;
    const mainContent = document.getElementById('main-content');
    mainContent.style.opacity = '0.3';
    setTimeout(() => {
        mainContent.innerHTML = html;
        mainContent.style.opacity = '1';
        processItemLinks();
        attachEventListeners(specData);
    }, FADE_TRANSITION_MS);
}
function attachEventListeners(specData) {
    // Phase button listeners
    document.querySelectorAll('.phase-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            if (e.ctrlKey || e.metaKey || e.button === 1) return;
            e.preventDefault();
            // Remove active state from all buttons
            document.querySelectorAll('.phase-btn').forEach(b => {
                b.classList.remove('bg-terminal-text', 'text-terminal-bg');
                b.classList.add('bg-transparent', 'text-terminal-text');
            });
            // Add active state to clicked button
            this.classList.remove('bg-transparent', 'text-terminal-text');
            this.classList.add('bg-terminal-text', 'text-terminal-bg');
            const phase = parseInt(this.getAttribute('data-phase'));
            currentPhase = phase;
            history.replaceState(null, '', `#${currentClass}/${currentSpec}/${phase}`);
            const phaseData = specData.phases[phase];
            document.getElementById('bis-header').textContent = `[ BEST IN SLOT - ${phaseData.name} ]`;
            document.getElementById('bis-table').innerHTML = generateBisTable(phaseData.bis, specData);
            processItemLinks();
        });
    });
    // Spec tab listeners
    document.querySelectorAll('.spec-tab').forEach(tab => {
        tab.addEventListener('click', function(e) {
            if (e.ctrlKey || e.metaKey || e.button === 1) return;
            e.preventDefault();
            const newSpec = this.getAttribute('data-spec');
            if (newSpec !== currentSpec) {
                currentSpec = newSpec;
                currentPhase = 1;
                window.location.hash = `#${currentClass}/${newSpec}`;
            }
        });
    });
}
// Pre-raid checker state
let preRaidClass = 'warrior';
let preRaidSpecName = null;
let preRaidGearText = '';
let preRaidDebounceTimer = null;
let selectedPhase = '1'; // Default to Phase 1 (Karazhan)

// Phase definitions - "Am I ready for X?"
const PHASES = [
    { key: '1', name: 'Phase 1 (Karazhan/Gruul/Mag)', shortName: 'Karazhan' },
    { key: '2', name: 'Phase 2 (SSC/TK)', shortName: 'SSC/TK' },
    { key: '3', name: 'Phase 3 (Hyjal/BT)', shortName: 'Hyjal/BT' },
    { key: '4', name: 'Phase 4 (ZA)', shortName: 'ZA' },
    { key: '5', name: 'Phase 5 (Sunwell)', shortName: 'Sunwell' }
];

// Minimum raid thresholds by role and phase
// These are realistic minimums to be "ready", not BiS targets
const RAID_THRESHOLDS = {
    caster_dps: {
        '1': { spellhit: 50, spelldamage: 500, stamina: 120, label: 'Karazhan' },
        '2': { spellhit: 76, spelldamage: 750, stamina: 160, label: 'SSC/TK' },
        '3': { spellhit: 101, spelldamage: 1000, stamina: 200, label: 'Hyjal/BT' },
        '4': { spellhit: 101, spelldamage: 1100, stamina: 230, label: 'ZA' },
        '5': { spellhit: 126, spelldamage: 1300, stamina: 280, label: 'Sunwell' }
    },
    healer: {
        '1': { healing: 1000, mp5: 40, stamina: 120, label: 'Karazhan' },
        '2': { healing: 1400, mp5: 60, stamina: 160, label: 'SSC/TK' },
        '3': { healing: 1700, mp5: 80, stamina: 200, label: 'Hyjal/BT' },
        '4': { healing: 1900, mp5: 90, stamina: 230, label: 'ZA' },
        '5': { healing: 2200, mp5: 110, stamina: 280, label: 'Sunwell' }
    },
    melee_dps: {
        '1': { hit: 50, attackpower: 800, crit: 40, stamina: 120, label: 'Karazhan' },
        '2': { hit: 75, attackpower: 1100, crit: 70, stamina: 160, label: 'SSC/TK' },
        '3': { hit: 100, attackpower: 1400, crit: 100, stamina: 220, label: 'Hyjal/BT' },
        '4': { hit: 110, attackpower: 1600, crit: 120, stamina: 260, label: 'ZA' },
        '5': { hit: 120, attackpower: 1900, crit: 150, stamina: 320, label: 'Sunwell' }
    },
    tank: {
        '1': { defense: 490, armor: 10000, stamina: 200, label: 'Karazhan' },
        '2': { defense: 490, armor: 13000, stamina: 280, label: 'SSC/TK' },
        '3': { defense: 490, armor: 16000, stamina: 350, label: 'Hyjal/BT' },
        '4': { defense: 490, armor: 18000, stamina: 400, label: 'ZA' },
        '5': { defense: 490, armor: 21000, stamina: 480, label: 'Sunwell' }
    }
};

// Map specs to roles
const SPEC_ROLES = {
    // Priest
    'shadow': 'caster_dps',
    'holy': 'healer',
    'discipline': 'healer',
    // Mage
    'fire': 'caster_dps',
    'frost': 'caster_dps',
    'arcane': 'caster_dps',
    // Warlock
    'affliction': 'caster_dps',
    'demonology': 'caster_dps',
    'destruction': 'caster_dps',
    // Druid
    'balance': 'caster_dps',
    'feral': 'melee_dps',
    'feral tank': 'tank',
    'restoration': 'healer',
    // Paladin
    'holy': 'healer',
    'protection': 'tank',
    'retribution': 'melee_dps',
    // Shaman
    'elemental': 'caster_dps',
    'enhancement': 'melee_dps',
    'restoration': 'healer',
    // Warrior
    'arms': 'melee_dps',
    'fury': 'melee_dps',
    'protection': 'tank',
    // Rogue
    'combat': 'melee_dps',
    'assassination': 'melee_dps',
    'subtlety': 'melee_dps',
    // Hunter
    'beast mastery': 'melee_dps',
    'marksmanship': 'melee_dps',
    'survival': 'melee_dps'
};

// Gear slots for scoring
const GEAR_SLOTS = ['HELM', 'NECK', 'SHOULDER', 'CLOAK', 'CHEST', 'BRACER', 'GLOVES', 'BELT', 'LEGS', 'BOOTS', 'RING', 'TRINKET', 'WEAPON', 'OFF-HAND', 'RANGED'];

// Cache for calculated BiS stats per phase/spec
let bisStatsCache = {};

// Find item ID from name (case-insensitive, partial match)
function findItemId(itemName) {
    if (!itemIds || typeof itemIds !== 'object') return null;
    const lower = itemName.toLowerCase().trim();
    if (!lower) return null;
    // Exact match first
    for (const name in itemIds) {
        if (name.toLowerCase() === lower) return itemIds[name];
    }
    // Partial match - item name contains search term
    for (const name in itemIds) {
        if (name.toLowerCase().includes(lower)) return itemIds[name];
    }
    return null;
}

// Cache for item searches
const itemSearchCache = {};

// Search for item ID by name using Blizzard API via backend
async function searchItemByName(itemName) {
    const lower = itemName.toLowerCase().trim();
    if (!lower) return null;

    // Check cache first
    if (itemSearchCache[lower] !== undefined) {
        return itemSearchCache[lower];
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/item-search?name=${encodeURIComponent(itemName)}`);
        if (!response.ok) {
            console.error('Item search failed:', response.status);
            return null;
        }

        const data = await response.json();
        if (data.items && data.items.length > 0) {
            // Find best match - require the names to actually relate
            const exactMatch = data.items.find(item =>
                item.name.toLowerCase() === lower
            );
            // Partial match: item name contains search OR search contains item name
            const partialMatch = data.items.find(item => {
                const itemLower = item.name.toLowerCase();
                return itemLower.includes(lower) || lower.includes(itemLower);
            });

            const result = exactMatch || partialMatch;
            if (!result) {
                // No good match found
                itemSearchCache[lower] = null;
                return null;
            }

            // Cache the result and add to local itemIds for future lookups
            itemSearchCache[lower] = result;
            if (result && result.id) {
                itemIds[lower] = result.id;
            }
            return result;
        }

        itemSearchCache[lower] = null;
        return null;
    } catch (e) {
        console.error('Item search error:', e);
        return null;
    }
}

// Extract item name without rating suffix
function cleanItemName(bisEntry) {
    // bisEntry is like "Overlord's Helmet of Second Sight (BEST)"
    return bisEntry.replace(/\s*\((BEST|RECOMMENDED|OPTION|EASY)\)\s*$/i, '').trim();
}

// Get rating weight for scoring
function getRatingWeight(bisEntry) {
    if (bisEntry.includes('(BEST)')) return 1.0;
    if (bisEntry.includes('(RECOMMENDED)')) return 0.85;
    if (bisEntry.includes('(OPTION)')) return 0.7;
    if (bisEntry.includes('(EASY)')) return 0.6;
    return 0.5;
}

// Get BiS list for a class/spec/phase
function getPhaseBisList(className, specName, phaseKey) {
    const cls = classData[className];
    if (!cls || !cls.specs || !cls.specs[specName]) return [];
    const spec = cls.specs[specName];
    if (!spec.phases) return [];
    // phases is an object with keys "0", "1", etc.
    const phase = spec.phases[phaseKey];
    return phase?.bis || [];
}

// Legacy function for compatibility
function getPreRaidBisList(className, specName) {
    return getPhaseBisList(className, specName, '0');
}

// Calculate total BiS stats for a phase by fetching all BiS items
async function calculatePhaseBisStats(className, specName, phaseKey) {
    const cacheKey = `${className}-${specName}-${phaseKey}`;
    if (bisStatsCache[cacheKey]) return bisStatsCache[cacheKey];

    const bisList = getPhaseBisList(className, specName, phaseKey);
    if (bisList.length === 0) return null;

    // Get only BEST items for each slot (or first item if no BEST marker)
    const bestBySlot = {};
    for (const [slot, itemName, source] of bisList) {
        if (itemName.includes('(BEST)') || !bestBySlot[slot]) {
            const cleanName = cleanItemName(itemName);
            const itemId = findItemId(cleanName);
            if (itemId) {
                bestBySlot[slot] = { itemId, name: cleanName };
            }
        }
    }

    // Get item IDs that need fetching
    const bisItemIds = Object.values(bestBySlot).map(item => item.itemId);
    await fetchAllItemStats(bisItemIds);

    // Debug: log what items are counted for BiS
    console.log(`[BiS ${phaseKey}] Slots:`, Object.keys(bestBySlot).length, Object.entries(bestBySlot).map(([slot, item]) => `${slot}: ${item.name}`));

    // Get stats from fetched cache
    const statsArray = Object.values(bestBySlot)
        .map(item => fetchedItemStats[item.itemId])
        .filter(stats => stats && Object.values(stats).some(v => typeof v === 'number' && v > 0));

    const totalStats = sumStats(statsArray);
    console.log(`[BiS ${phaseKey}] Total stats:`, totalStats);
    bisStatsCache[cacheKey] = totalStats;
    return totalStats;
}

// Get status based on stat comparison to BiS
function getStatStatus(userValue, bisValue, prevBisValue) {
    if (bisValue === 0) return { status: '-', class: 'text-terminal-dim' };

    const percent = (userValue / bisValue) * 100;

    if (percent >= 100) {
        return { status: 'BiS', class: 'text-wow-legendary' };
    } else if (percent >= 90) {
        return { status: 'GOOD', class: 'text-terminal-accent' };
    } else if (prevBisValue && userValue >= prevBisValue * 0.8) {
        return { status: 'PREPARED', class: 'text-yellow-400' };
    } else {
        return { status: 'LOW', class: 'text-red-400' };
    }
}

// Get overall readiness status
function getOverallStatus(userStats, bisStats, prevBisStats) {
    // Include both melee and caster stats - only count ones where BiS > 0
    const keyStats = ['stamina', 'hit', 'crit', 'attackpower', 'spelldamage', 'spellhit', 'spellcrit', 'healing', 'defense', 'mp5'];
    let bisCount = 0, goodCount = 0, preparedCount = 0, totalRelevant = 0;

    for (const stat of keyStats) {
        if (bisStats[stat] > 0) {
            totalRelevant++;
            const percent = (userStats[stat] / bisStats[stat]) * 100;
            if (percent >= 100) bisCount++;
            else if (percent >= 90) goodCount++;
            else if (prevBisStats && userStats[stat] >= prevBisStats[stat] * 0.8) preparedCount++;
        }
    }

    if (totalRelevant === 0) return { status: 'NO DATA', class: 'text-terminal-dim' };
    if (bisCount === totalRelevant) return { status: 'BiS', class: 'text-wow-legendary' };
    if (bisCount + goodCount >= totalRelevant * 0.8) return { status: 'GOOD', class: 'text-terminal-accent' };
    if (bisCount + goodCount + preparedCount >= totalRelevant * 0.6) return { status: 'PREPARED', class: 'text-yellow-400' };
    return { status: 'UNDERGEARED', class: 'text-red-400' };
}

// Get role for a spec
function getSpecRole(specName) {
    const lower = specName?.toLowerCase() || '';
    return SPEC_ROLES[lower] || 'caster_dps'; // Default to caster
}

// Check user stats against raid thresholds
function checkRaidThresholds(userStats, role, phaseKey) {
    const thresholds = RAID_THRESHOLDS[role]?.[phaseKey];
    if (!thresholds) return { passed: [], failed: [], label: 'Unknown' };

    const results = { passed: [], failed: [], label: thresholds.label };

    for (const [stat, minValue] of Object.entries(thresholds)) {
        if (stat === 'label') continue;

        const userValue = userStats[stat] || 0;
        const statLabels = {
            hit: 'Hit Rating', spellhit: 'Spell Hit', spelldamage: 'Spell Damage', stamina: 'Stamina',
            healing: 'Healing', mp5: 'MP5', attackpower: 'Attack Power',
            crit: 'Crit %', defense: 'Defense', armor: 'Armor', dodge: 'Dodge %'
        };

        const entry = {
            stat,
            label: statLabels[stat] || stat,
            current: userValue,
            required: minValue,
            diff: userValue - minValue
        };

        if (userValue >= minValue) {
            results.passed.push(entry);
        } else {
            results.failed.push(entry);
        }
    }

    return results;
}

// Compare user items to BiS list by slot
function compareItemsToBis(userItemNames, bisList) {
    const results = {};
    const usedUserItems = new Set(); // Track which user items have been matched

    // Build BiS lookup by slot (keep RING 1, RING 2, etc. separate)
    const bisBySlot = {};
    for (const [slot, itemName, source] of bisList) {
        if (!bisBySlot[slot]) bisBySlot[slot] = [];
        bisBySlot[slot].push({
            name: cleanItemName(itemName),
            source,
            rating: getRatingWeight(itemName)
        });
    }

    // Check each BiS slot
    for (const [slot, bisItems] of Object.entries(bisBySlot)) {
        const bestBis = bisItems.find(i => i.rating >= 1) || bisItems[0];

        // Find if user has any item for this slot (that hasn't been used yet)
        let userMatch = null;
        let matchType = 'MISSING';

        for (const userName of userItemNames) {
            if (usedUserItems.has(userName.toLowerCase())) continue; // Skip already matched items

            const cleanUser = userName.toLowerCase().trim();

            // Check if user item matches any BiS item for this slot
            for (const bisItem of bisItems) {
                const cleanBis = bisItem.name.toLowerCase();
                if (cleanUser === cleanBis || cleanUser.includes(cleanBis) || cleanBis.includes(cleanUser)) {
                    userMatch = userName;
                    usedUserItems.add(userName.toLowerCase());
                    if (bisItem.rating >= 1) {
                        matchType = 'BiS';
                    } else if (bisItem.rating >= 0.7) {
                        matchType = 'GOOD';
                    } else {
                        matchType = 'OK';
                    }
                    break;
                }
            }
            if (userMatch) break;
        }

        // Display slot name without number for cleaner UI
        const displaySlot = slot.replace(/\s*\d+$/, '');
        results[slot] = {
            displaySlot,
            userItem: userMatch,
            bisItem: bestBis?.name || 'Unknown',
            bisSource: bestBis?.source || '',
            status: matchType
        };
    }

    return results;
}

// Parse gear list and match against BiS
function parseAndMatchGear(gearText, bisList) {
    const lines = gearText.split('\n').map(l => l.trim()).filter(l => l);
    const results = [];

    for (const line of lines) {
        const itemId = findItemId(line);
        let bisMatch = null;
        let slot = null;
        let rating = null;

        // Check if this item is in the BiS list
        for (const bisEntry of bisList) {
            const [bisSlot, bisItemName, bisSource] = bisEntry;
            const cleanBisName = cleanItemName(bisItemName);
            if (cleanBisName.toLowerCase() === line.toLowerCase() ||
                cleanBisName.toLowerCase().includes(line.toLowerCase()) ||
                line.toLowerCase().includes(cleanBisName.toLowerCase())) {
                bisMatch = bisEntry;
                slot = bisSlot;
                rating = getRatingWeight(bisItemName);
                break;
            }
        }

        results.push({
            input: line,
            itemId,
            found: !!itemId,
            bisMatch,
            slot,
            rating: rating || (itemId ? 0.3 : 0) // Recognized items get some credit
        });
    }

    return results;
}

// Stat requirements for raids (unbuffed minimums)
const RAID_REQUIREMENTS = {
    karazhan: {
        tank: { stamina: 400, defense: 490, armor: 12000 },
        melee: { stamina: 250, hit: 95, attackpower: 1400, crit: 20 },
        caster: { stamina: 200, spellhit: 76, spelldamage: 700, intellect: 300 },
        healer: { stamina: 200, healing: 1000, mp5: 50, intellect: 350 }
    },
    gruul: {
        tank: { stamina: 500, defense: 490, armor: 14000 },
        melee: { stamina: 300, hit: 142, attackpower: 1600, crit: 22 },
        caster: { stamina: 250, spellhit: 126, spelldamage: 900, intellect: 350 },
        healer: { stamina: 250, healing: 1200, mp5: 70, intellect: 400 }
    },
    ssc_tk: {
        tank: { stamina: 600, defense: 490, armor: 16000 },
        melee: { stamina: 350, hit: 142, attackpower: 1800, crit: 25 },
        caster: { stamina: 300, spellhit: 126, spelldamage: 1100, intellect: 400 },
        healer: { stamina: 300, healing: 1500, mp5: 90, intellect: 450 }
    }
};

// Calculate readiness score based on BiS matches
function calculateGearReadiness(matchResults) {
    if (matchResults.length === 0) return 0;

    // Count BiS matches by slot
    const slotsFilled = {};

    for (const result of matchResults) {
        if (result.slot && result.rating) {
            // Take the best rating for each slot
            if (!slotsFilled[result.slot] || slotsFilled[result.slot] < result.rating) {
                slotsFilled[result.slot] = result.rating;
            }
        }
    }

    // Calculate score based on slots filled
    const filledSlots = Object.keys(slotsFilled).length;
    const totalSlots = 15; // Approximate total gear slots
    const avgRating = filledSlots > 0 ? Object.values(slotsFilled).reduce((a, b) => a + b, 0) / filledSlots : 0;

    // Score = coverage * quality
    const coverage = Math.min(filledSlots / totalSlots, 1);
    return Math.round(coverage * avgRating * 100);
}

// Parse stats from Wowhead tooltip HTML - OPTIMIZED single-pass DFA-style
function parseTooltipStats(tooltipHtml) {
    const stats = {
        stamina: 0, intellect: 0, strength: 0, agility: 0, spirit: 0,
        armor: 0, defense: 0, dodge: 0, parry: 0, block: 0,
        hit: 0, crit: 0, haste: 0, expertise: 0, attackpower: 0, armorpen: 0,
        spellhit: 0, spellcrit: 0, spellhaste: 0, spelldamage: 0, healing: 0, mp5: 0
    };
    if (!tooltipHtml) return stats;

    // Strip HTML tags and decode entities to get plain text
    const text = tooltipHtml
        .replace(/<[^>]+>/g, ' ')  // Remove HTML tags
        .replace(/&nbsp;/g, ' ')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&')
        .replace(/Socket Bonus:.*?(?=Durability|Requires|Equip:|$)/gi, '')  // Remove socket bonus
        .replace(/\s+/g, ' ');     // Normalize whitespace

    console.log('[TEXT]', text.substring(0, 300));

    // Simple patterns for plain text
    const patterns = [
        [/\+(\d+)\s+Stamina/gi, 'stamina'],
        [/\+(\d+)\s+Intellect/gi, 'intellect'],
        [/\+(\d+)\s+Strength/gi, 'strength'],
        [/\+(\d+)\s+Agility/gi, 'agility'],
        [/\+(\d+)\s+Spirit/gi, 'spirit'],
        [/\+(\d+)\s+Hit Rating/gi, 'hit'],
        [/\+(\d+)\s+Critical Strike Rating/gi, 'crit'],
        [/\+(\d+)\s+Haste Rating/gi, 'haste'],
        [/\+(\d+)\s+Expertise Rating/gi, 'expertise'],
        [/\+(\d+)\s+Attack Power/gi, 'attackpower'],
        [/\+(\d+)\s+Armor Penetration/gi, 'armorpen'],
        [/\+(\d+)\s+Defense Rating/gi, 'defense'],
        [/\+(\d+)\s+Dodge Rating/gi, 'dodge'],
        [/\+(\d+)\s+Parry Rating/gi, 'parry'],
        [/\+(\d+)\s+Block Rating/gi, 'block'],
        [/(\d+)\s+Armor/gi, 'armor'],
        // Equip effects
        [/spell hit rating by (\d+)/gi, 'spellhit'],
        [/spell critical strike rating by (\d+)/gi, 'spellcrit'],
        [/spell haste rating by (\d+)/gi, 'spellhaste'],
        [/healing done by up to (\d+)/gi, 'healing'],
        [/healing done by spells by up to (\d+)/gi, 'healing'],
        [/damage and healing[^0-9]+by (?:up to )?(\d+)/gi, 'spelldamage'],
        [/spell power by (\d+)/gi, 'spelldamage'],
        [/hit rating by (\d+)/gi, 'hit'],
        [/critical strike rating by (\d+)/gi, 'crit'],
        [/haste rating by (\d+)/gi, 'haste'],
        [/attack power by (\d+)/gi, 'attackpower'],
        [/(\d+) mana per 5/gi, 'mp5'],
    ];

    // Apply all patterns and SUM the values (not replace)
    for (const [pattern, statKey] of patterns) {
        let match;
        while ((match = pattern.exec(text)) !== null) {
            const val = parseInt(match[1], 10);
            if (val > 0) {
                stats[statKey] += val;
            }
        }
    }

    // Debug output
    const nonZero = Object.entries(stats).filter(([k,v]) => v > 0);
    console.log('[PARSED]', nonZero.length > 0 ? Object.fromEntries(nonZero) : 'NONE');

    return stats;
}

// Sum stats from multiple items
function sumStats(statsArray) {
    const total = {
        stamina: 0, intellect: 0, strength: 0, agility: 0, spirit: 0,
        armor: 0, defense: 0, dodge: 0, parry: 0, block: 0,
        hit: 0, crit: 0, haste: 0, expertise: 0, attackpower: 0, armorpen: 0,
        spellhit: 0, spellcrit: 0, spellhaste: 0, spelldamage: 0, healing: 0, mp5: 0
    };
    for (const stats of statsArray) {
        for (const key in total) {
            total[key] += stats[key] || 0;
        }
    }
    return total;
}

// Global cache for fetched item stats
let fetchedItemStats = {};
let tooltipFetchInProgress = false;
let preloadContainer = null;

// OUR OWN tooltip cache - populated by XHR/JSONP intercept
let capturedTooltips = {};

// Helper to extract tooltip from response text
function extractTooltipFromResponse(text, itemIdHint) {
    // Try to find tooltip_enus in the response
    const tooltipMatch = text.match(/"tooltip_enus"\s*:\s*"((?:[^"\\]|\\.)*)"/);
    if (tooltipMatch) {
        // Try to find item ID near the tooltip
        const idMatch = text.match(/["\[](\d{4,6})["\]]/);
        const itemId = idMatch ? idMatch[1] : itemIdHint;
        if (itemId) {
            const tooltip = tooltipMatch[1]
                .replace(/\\"/g, '"')
                .replace(/\\n/g, '\n')
                .replace(/\\\\/g, '\\')
                .replace(/\\u003c/g, '<')
                .replace(/\\u003e/g, '>')
                .replace(/\\u0026/g, '&');
            capturedTooltips[itemId] = tooltip;
            console.log('[CAPTURED]', itemId, tooltip.substring(0, 80));
            return true;
        }
    }
    return false;
}

// Intercept XMLHttpRequest to capture Wowhead tooltip responses
(function() {
    const origOpen = XMLHttpRequest.prototype.open;
    const origSend = XMLHttpRequest.prototype.send;

    XMLHttpRequest.prototype.open = function(method, url) {
        this._whUrl = url;
        return origOpen.apply(this, arguments);
    };

    XMLHttpRequest.prototype.send = function() {
        const xhr = this;
        const url = xhr._whUrl || '';

        // Check if this is a Wowhead request
        if (url.includes('wowhead.com')) {
            console.log('[XHR]', url);
            xhr.addEventListener('load', function() {
                try {
                    const text = xhr.responseText;
                    console.log('[XHR RESPONSE]', url, text.substring(0, 200));

                    // Extract item ID from URL if present
                    const idMatch = url.match(/item[=\/](\d+)/);
                    extractTooltipFromResponse(text, idMatch ? idMatch[1] : null);
                } catch(e) {
                    console.log('[XHR ERROR]', e);
                }
            });
        }
        return origSend.apply(this, arguments);
    };
})();

// Also intercept fetch API
(function() {
    const origFetch = window.fetch;
    window.fetch = function(url, options) {
        const urlStr = typeof url === 'string' ? url : url.url || '';

        if (urlStr.includes('wowhead.com')) {
            console.log('[FETCH API]', urlStr);
            return origFetch.apply(this, arguments).then(response => {
                const clone = response.clone();
                clone.text().then(text => {
                    console.log('[FETCH RESPONSE]', urlStr, text.substring(0, 200));
                    const idMatch = urlStr.match(/item[=\/](\d+)/);
                    extractTooltipFromResponse(text, idMatch ? idMatch[1] : null);
                });
                return response;
            });
        }
        return origFetch.apply(this, arguments);
    };
})();

// Watch for JSONP script insertions and intercept Wowhead callbacks
(function() {
    // Monitor script insertions
    const observer = new MutationObserver(mutations => {
        for (const mutation of mutations) {
            for (const node of mutation.addedNodes) {
                if (node.tagName === 'SCRIPT' && node.src && node.src.includes('wowhead.com')) {
                    console.log('[SCRIPT ADDED]', node.src);
                }
            }
        }
    });
    observer.observe(document.documentElement, { childList: true, subtree: true });

    // Intercept $WowheadPower methods when it becomes available
    function hookWowhead() {
        if (typeof $WowheadPower === 'undefined') {
            setTimeout(hookWowhead, 100);
            return;
        }

        console.log('[WOWHEAD] Hooking $WowheadPower, methods:', Object.keys($WowheadPower));

        // Try to find and hook the item registration function
        const checkObj = obj => {
            if (!obj || typeof obj !== 'object') return;
            for (const key of Object.keys(obj)) {
                if (typeof obj[key] === 'function' && (key.includes('register') || key.includes('item') || key.includes('tooltip'))) {
                    const orig = obj[key];
                    obj[key] = function() {
                        console.log('[WOWHEAD CALL]', key, arguments);
                        return orig.apply(this, arguments);
                    };
                }
            }
        };

        checkObj($WowheadPower);
        if (typeof WH !== 'undefined') checkObj(WH);
    }

    hookWowhead();
})();

// Get tooltip from our captured cache
function getTooltipFromCache(itemId) {
    return capturedTooltips[String(itemId)] || null;
}

// Direct fetch from Wowhead tooltip API
async function fetchTooltipDirect(itemId) {
    if (capturedTooltips[itemId]) {
        return capturedTooltips[itemId];
    }

    // Try multiple Wowhead API endpoints - TBC Classic uses dataEnv=5
    const endpoints = [
        `https://nether.wowhead.com/tooltip/item/${itemId}?dataEnv=5&locale=0`,
        `https://nether.wowhead.com/tooltip/item/${itemId}?dataEnv=4&locale=0`,
        `https://nether.wowhead.com/tbc/tooltip/item/${itemId}`,
        `https://tbc.wowhead.com/tooltip/item/${itemId}`
    ];

    for (const url of endpoints) {
        try {
            console.log('[FETCH TRYING]', url);
            const response = await fetch(url);
            console.log('[FETCH STATUS]', itemId, response.status);

            if (response.ok) {
                const data = await response.json();
                console.log('[FETCH DATA]', itemId, Object.keys(data));

                if (data.tooltip) {
                    capturedTooltips[itemId] = data.tooltip;
                    console.log('[FETCH OK]', itemId, data.tooltip.substring(0, 80));
                    return data.tooltip;
                }
            }
        } catch(e) {
            console.log('[FETCH ERROR]', url, e.message);
        }
    }

    return null;
}

// OPTIMIZED: Fetch ALL items directly from Wowhead API
async function fetchAllItemStats(itemIds) {
    console.log('[FETCH] fetchAllItemStats called with:', itemIds);
    if (tooltipFetchInProgress) {
        console.log('[FETCH] Already in progress, returning');
        return;
    }
    tooltipFetchInProgress = true;

    const statusDiv = document.getElementById('stats-status');
    const emptyStats = { stamina: 0, intellect: 0, strength: 0, agility: 0, spirit: 0, armor: 0, defense: 0, dodge: 0, parry: 0, block: 0, hit: 0, crit: 0, haste: 0, expertise: 0, attackpower: 0, armorpen: 0, spellhit: 0, spellcrit: 0, spellhaste: 0, spelldamage: 0, healing: 0, mp5: 0 };

    const toFetch = itemIds.filter(id => !fetchedItemStats[id]);
    console.log('[FETCH] Items to fetch (not cached):', toFetch);
    if (toFetch.length === 0) {
        if (statusDiv) statusDiv.innerHTML = '<span class="text-terminal-accent">Stats cached!</span>';
        tooltipFetchInProgress = false;
        return;
    }

    if (statusDiv) statusDiv.innerHTML = `<span class="text-yellow-400">Loading ${toFetch.length} items...</span>`;

    // Fetch all items in parallel using direct API
    let loaded = 0;
    const fetchPromises = toFetch.map(async (id) => {
        const tooltip = await fetchTooltipDirect(id);
        if (tooltip) {
            fetchedItemStats[id] = parseTooltipStats(tooltip);
            loaded++;
        } else {
            fetchedItemStats[id] = { ...emptyStats };
        }
        if (statusDiv) statusDiv.innerHTML = `<span class="text-yellow-400">Loading... ${loaded}/${toFetch.length}</span>`;
    });

    await Promise.all(fetchPromises);

    if (statusDiv) statusDiv.innerHTML = `<span class="text-terminal-accent">${loaded}/${toFetch.length} loaded</span>`;
    tooltipFetchInProgress = false;
}

// Update the stats display with phase-based BiS comparison
async function updateStatsDisplay(itemIdsList) {
    const statsDiv = document.getElementById('total-stats');
    const readinessDiv = document.getElementById('stat-readiness');
    if (!statsDiv) return;

    // If no itemIdsList provided, try to get from gear input
    if (!itemIdsList) {
        const gearText = document.getElementById('gear-input')?.value || '';
        const lines = gearText.split('\n').map(l => l.trim()).filter(l => l);
        itemIdsList = lines.map(l => findItemId(l)).filter(Boolean);
    }

    // Get stats from fetched cache
    const userItemStats = itemIdsList
        .map(id => fetchedItemStats[id])
        .filter(stats => stats && Object.values(stats).some(v => typeof v === 'number' && v > 0));

    if (userItemStats.length === 0) {
        statsDiv.innerHTML = '<span class="text-yellow-400">No stats loaded yet. Click Calculate Stats.</span>';
        if (readinessDiv) readinessDiv.innerHTML = '';
        return;
    }

    const userTotal = sumStats(userItemStats);

    // Get BiS stats for selected phase and previous phase
    const bisStats = await calculatePhaseBisStats(preRaidClass, preRaidSpecName, selectedPhase);
    const prevPhaseKey = String(Math.max(0, parseInt(selectedPhase) - 1));
    const prevBisStats = prevPhaseKey !== selectedPhase ? await calculatePhaseBisStats(preRaidClass, preRaidSpecName, prevPhaseKey) : null;

    // Key stats to display with comparison
    const statDefs = [
        { key: 'stamina', label: 'Stamina' },
        { key: 'intellect', label: 'Intellect' },
        { key: 'strength', label: 'Strength' },
        { key: 'agility', label: 'Agility' },
        { key: 'hit', label: 'Hit Rating' },
        { key: 'crit', label: 'Crit Rating' },
        { key: 'haste', label: 'Haste' },
        { key: 'expertise', label: 'Expertise' },
        { key: 'attackpower', label: 'Attack Power' },
        { key: 'armorpen', label: 'Armor Pen' },
        { key: 'spelldamage', label: 'Spell Damage' },
        { key: 'spellhit', label: 'Spell Hit' },
        { key: 'spellcrit', label: 'Spell Crit' },
        { key: 'healing', label: 'Healing' },
        { key: 'mp5', label: 'MP5' },
        { key: 'defense', label: 'Defense' },
        { key: 'dodge', label: 'Dodge' },
        { key: 'parry', label: 'Parry' },
        { key: 'armor', label: 'Armor' }
    ];

    // Filter to only show stats that are relevant (user has or BiS has)
    const relevantStats = statDefs.filter(s =>
        userTotal[s.key] > 0 || (bisStats && bisStats[s.key] > 0)
    );

    // Build stats comparison table
    let statsHtml = `<div class="space-y-1 text-xs">`;
    for (const s of relevantStats) {
        const userVal = userTotal[s.key] || 0;
        const bisVal = bisStats ? (bisStats[s.key] || 0) : 0;
        const prevVal = prevBisStats ? (prevBisStats[s.key] || 0) : 0;
        const status = getStatStatus(userVal, bisVal, prevVal);

        statsHtml += `
            <div class="flex items-center justify-between">
                <span class="text-terminal-dim">${s.label}:</span>
                <div class="flex items-center gap-2">
                    <span class="text-terminal-text">${userVal}</span>
                    ${bisVal > 0 ? `<span class="text-terminal-dim">/ ${bisVal}</span>` : ''}
                    <span class="${status.class} text-[10px] font-bold w-16 text-right">${status.status}</span>
                </div>
            </div>
        `;
    }
    statsHtml += `</div>`;
    statsDiv.innerHTML = statsHtml;

    // Calculate readiness using thresholds and slot comparison
    if (readinessDiv) {
        const phaseName = PHASES.find(p => p.key === selectedPhase)?.shortName || `Phase ${selectedPhase}`;
        const role = getSpecRole(preRaidSpecName);
        const thresholds = checkRaidThresholds(userTotal, role, selectedPhase);

        // Get user item names for slot comparison
        const gearText = document.getElementById('gear-input')?.value || '';
        const userItemNames = gearText.split('\n').map(l => l.trim()).filter(l => l);
        const bisList = getPhaseBisList(preRaidClass, preRaidSpecName, selectedPhase);
        const slotComparison = compareItemsToBis(userItemNames, bisList);

        // Determine overall status based on thresholds
        const allPassed = thresholds.failed.length === 0;
        const mostPassed = thresholds.failed.length <= 1;
        const overallStatus = allPassed ? { text: 'READY', class: 'text-terminal-accent' } :
                              mostPassed ? { text: 'ALMOST READY', class: 'text-yellow-400' } :
                              { text: 'NOT READY', class: 'text-red-400' };

        let readinessHtml = `
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-terminal-text text-xs uppercase">${thresholds.label} Requirements</h4>
                    <span class="${overallStatus.class} text-sm font-bold">[${overallStatus.text}]</span>
                </div>

                <div class="space-y-1 text-xs mb-4">
        `;

        // Show passed thresholds
        for (const t of thresholds.passed) {
            readinessHtml += `
                <div class="flex items-center justify-between">
                    <span class="text-terminal-accent">✓ ${t.label}</span>
                    <span class="text-terminal-text">${t.current} / ${t.required}</span>
                </div>
            `;
        }

        // Show failed thresholds
        for (const t of thresholds.failed) {
            const needed = t.required - t.current;
            readinessHtml += `
                <div class="flex items-center justify-between">
                    <span class="text-red-400">✗ ${t.label}</span>
                    <span class="text-red-400">${t.current} / ${t.required} <span class="text-[10px]">(need ${needed})</span></span>
                </div>
            `;
        }

        readinessHtml += `
                </div>
            </div>
        `;

        // Slot-by-slot comparison
        const slotEntries = Object.entries(slotComparison);
        if (slotEntries.length > 0) {
            readinessHtml += `
                <div class="border-t border-terminal-dim/30 pt-3 mt-3">
                    <h5 class="text-terminal-dim text-[10px] uppercase mb-2">// Gear Slots</h5>
                    <div class="space-y-1 text-[10px] max-h-48 overflow-y-auto">
            `;

            for (const [slot, data] of slotEntries) {
                const statusColors = {
                    'BiS': 'text-wow-legendary',
                    'GOOD': 'text-terminal-accent',
                    'OK': 'text-yellow-400',
                    'MISSING': 'text-red-400'
                };
                const statusColor = statusColors[data.status] || 'text-terminal-dim';

                const slotLabel = data.displaySlot || slot;
                if (data.status === 'MISSING') {
                    readinessHtml += `
                        <div class="flex items-center justify-between gap-2">
                            <span class="text-terminal-dim w-16 flex-shrink-0">${slotLabel}</span>
                            <span class="text-red-400 flex-1 truncate">— Need: ${data.bisItem}</span>
                            <span class="${statusColor} font-bold w-14 text-right">[${data.status}]</span>
                        </div>
                    `;
                } else {
                    readinessHtml += `
                        <div class="flex items-center justify-between gap-2">
                            <span class="text-terminal-dim w-16 flex-shrink-0">${slotLabel}</span>
                            <span class="text-terminal-text flex-1 truncate">${data.userItem || '—'}</span>
                            <span class="${statusColor} font-bold w-14 text-right">[${data.status}]</span>
                        </div>
                    `;
                }
            }

            readinessHtml += `
                    </div>
                </div>
            `;
        }

        readinessDiv.innerHTML = readinessHtml;
    }
}
// Detect role based on stats
function detectRole(stats) {
    if (stats.defense > 100 || stats.parry > 50 || stats.dodge > 50) return 'tank';
    if (stats.healing > stats.spelldamage && stats.healing > 0) return 'healer';
    if (stats.spelldamage > 200 || stats.spellhit > 50) return 'caster';
    return 'melee';
}

// Update gear preview with Wowhead tooltips
async function updateGearPreview() {
    const previewDiv = document.getElementById('gear-preview');
    if (!previewDiv) return;

    const gearText = document.getElementById('gear-input')?.value || '';
    preRaidGearText = gearText;

    if (!gearText.trim()) {
        previewDiv.innerHTML = '<span class="text-terminal-dim">Items will appear here as you type...</span>';
        return;
    }

    const bisList = getPreRaidBisList(preRaidClass, preRaidSpecName);
    const matchResults = parseAndMatchGear(gearText, bisList);

    // Find items not in local database and search Blizzard API
    const unknownItems = matchResults.filter(r => !r.itemId);
    if (unknownItems.length > 0) {
        // Show searching indicator
        const searchingHtml = matchResults.map(r => {
            if (r.itemId) {
                const bisTag = r.bisMatch ? `<span class="text-terminal-accent ml-2">[BiS${r.slot ? ' - ' + r.slot : ''}]</span>` : '';
                return `<div class="py-1"><a href="https://tbc.wowhead.com/item=${r.itemId}" data-wowhead="item=${r.itemId}" class="text-wow-uncommon hover:text-terminal-text">${r.input}</a>${bisTag}</div>`;
            }
            return `<div class="py-1"><span class="text-yellow-400">${r.input}</span> <span class="text-terminal-dim">(searching...)</span></div>`;
        }).join('');
        previewDiv.innerHTML = searchingHtml;

        // Search for unknown items via Blizzard API
        await Promise.all(unknownItems.map(async (r) => {
            const result = await searchItemByName(r.input);
            if (result && result.id) {
                r.itemId = result.id;
                r.found = true;
                r.fromBlizzard = true;
            }
        }));
    }

    // Build final preview HTML
    const previewHtml = matchResults.map(r => {
        if (r.itemId) {
            const bisTag = r.bisMatch ? `<span class="text-terminal-accent ml-2">[BiS${r.slot ? ' - ' + r.slot : ''}]</span>` : '';
            const foundTag = r.fromBlizzard ? `<span class="text-blue-400 ml-2">[Found]</span>` : '';
            return `<div class="py-1"><a href="https://tbc.wowhead.com/item=${r.itemId}" data-wowhead="item=${r.itemId}" class="text-wow-uncommon hover:text-terminal-text">${r.input}</a>${bisTag}${foundTag}</div>`;
        }
        return `<div class="py-1"><span class="text-red-400">${r.input}</span> <span class="text-terminal-dim">(not found)</span></div>`;
    }).join('');

    previewDiv.innerHTML = previewHtml || '<span class="text-terminal-dim">No items entered</span>';

    // Refresh Wowhead tooltips
    if (typeof $WowheadPower !== 'undefined' && $WowheadPower.refreshLinks) {
        $WowheadPower.refreshLinks();
    }
}

function renderPreRaidChecker() {
    currentClass = null;
    document.querySelectorAll('.class-list li').forEach(li => li.classList.remove('active'));
    const preRaidLink = document.querySelector('.class-list li[data-view="preraid"]');
    if (preRaidLink) preRaidLink.classList.add('active');

    // Get available classes and specs
    const classes = Object.keys(classData);
    if (!preRaidClass || !classData[preRaidClass]) {
        preRaidClass = classes[0] || 'warrior';
    }
    const specs = classData[preRaidClass]?.specs ? Object.keys(classData[preRaidClass].specs) : [];
    if (!preRaidSpecName || !specs.includes(preRaidSpecName)) {
        preRaidSpecName = classData[preRaidClass]?.defaultSpec || specs[0];
    }

    const phaseName = PHASES.find(p => p.key === selectedPhase)?.name || 'Phase 1';

    const html = `
        <div class="command-line text-terminal-dim my-5 md:text-[11px] md:my-3 sm:text-[10px]">./gear-checker --class=${preRaidClass} --spec=${preRaidSpecName} --phase=${selectedPhase}</div>
        <h2 class="text-terminal-accent text-lg mb-2 uppercase tracking-wide md:text-base sm:text-sm">[ GEAR CHECKER ]</h2>
        <p class="text-terminal-dim text-xs mb-6 md:mb-4 sm:mb-3">Paste your gear list to compare against BiS for any raid tier</p>

        <div class="grid grid-cols-3 gap-4 mb-6 md:grid-cols-1">
            <div>
                <label class="text-terminal-dim text-xs block mb-2">CLASS</label>
                <select id="preraid-class" class="w-full bg-terminal-bg border border-terminal-text text-terminal-text px-3 py-2 text-xs font-mono cursor-pointer">
                    ${classes.map(c => `<option value="${c}" ${c === preRaidClass ? 'selected' : ''}>${classData[c]?.title || c}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="text-terminal-dim text-xs block mb-2">SPEC</label>
                <select id="preraid-spec" class="w-full bg-terminal-bg border border-terminal-text text-terminal-text px-3 py-2 text-xs font-mono cursor-pointer">
                    ${specs.map(s => `<option value="${s}" ${s === preRaidSpecName ? 'selected' : ''}>${classData[preRaidClass]?.specs[s]?.title || s}</option>`).join('')}
                </select>
            </div>
            <div>
                <label class="text-terminal-dim text-xs block mb-2">READY FOR</label>
                <select id="phase-select" class="w-full bg-terminal-bg border border-terminal-accent text-terminal-accent px-3 py-2 text-xs font-mono cursor-pointer">
                    ${PHASES.map(p => `<option value="${p.key}" ${p.key === selectedPhase ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </div>
        </div>

        <div class="mb-4">
            <label class="text-terminal-dim text-xs block mb-2">PASTE YOUR GEAR <span class="text-terminal-accent">(one item per line)</span></label>
            <textarea id="gear-input" class="w-full bg-terminal-bg border border-terminal-text text-terminal-text px-3 py-2 text-xs font-mono h-40 resize-y" placeholder="Overlord's Helmet of Second Sight
Choker of Vile Intent
Wastewalker Shoulderpads
...">${preRaidGearText}</textarea>
        </div>

        <div class="mb-4">
            <label class="text-terminal-dim text-xs block mb-2">RECOGNIZED ITEMS</label>
            <div id="gear-preview" class="border border-terminal-dim/50 p-3 min-h-[60px] text-xs max-h-60 overflow-y-auto">
                <span class="text-terminal-dim">Items will appear here as you type...</span>
            </div>
        </div>

        <div class="mb-6">
            <button id="fetch-stats-btn" class="bg-terminal-accent text-terminal-bg px-6 py-2 font-mono text-xs font-bold cursor-pointer hover:bg-terminal-text transition-colors">
                [ CALCULATE STATS ]
            </button>
            <span id="stats-status" class="ml-3 text-xs"></span>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-6 md:grid-cols-1">
            <div class="border border-terminal-dim/50 p-4">
                <h4 class="text-terminal-text text-xs uppercase mb-3">// Total Gear Stats</h4>
                <div id="total-stats">
                    <span class="text-terminal-dim text-xs">Click "Calculate Stats" to fetch item stats from Wowhead</span>
                </div>
            </div>
            <div class="border border-terminal-dim/50 p-4">
                <div id="stat-readiness">
                    <span class="text-terminal-dim text-xs">Raid readiness will appear after stats are calculated</span>
                </div>
            </div>
        </div>
    `;

    const mainContent = document.getElementById('main-content');
    mainContent.style.opacity = '0.3';
    setTimeout(() => {
        mainContent.innerHTML = html;
        mainContent.style.opacity = '1';

        // Class selector change
        document.getElementById('preraid-class').addEventListener('change', (e) => {
            preRaidClass = e.target.value;
            preRaidSpecName = classData[preRaidClass]?.defaultSpec || Object.keys(classData[preRaidClass]?.specs || {})[0];
            renderPreRaidChecker();
        });

        // Spec selector change
        document.getElementById('preraid-spec').addEventListener('change', (e) => {
            preRaidSpecName = e.target.value;
            bisStatsCache = {}; // Clear cache when spec changes
            updateGearPreview();
            // Update stats display if we have fetched data
            updateStatsDisplay();
        });

        // Phase selector change
        document.getElementById('phase-select').addEventListener('change', (e) => {
            selectedPhase = e.target.value;
            bisStatsCache = {}; // Clear cache when phase changes
            // Recalculate stats display
            updateStatsDisplay();
        });

        // Calculate stats button - fetches from Wowhead dynamically
        document.getElementById('fetch-stats-btn').addEventListener('click', async () => {
            console.log('[BUTTON] Calculate Stats clicked!');
            const gearText = document.getElementById('gear-input')?.value || '';
            const lines = gearText.split('\n').map(l => l.trim()).filter(l => l);
            console.log('[BUTTON] Lines:', lines);
            const itemIdsList = [];

            for (const line of lines) {
                const itemId = findItemId(line);
                console.log('[BUTTON] Item:', line, '-> ID:', itemId);
                if (itemId) itemIdsList.push(itemId);
            }

            console.log('[BUTTON] Item IDs to fetch:', itemIdsList);

            if (itemIdsList.length > 0) {
                // Clear BiS cache to force recalculation
                bisStatsCache = {};
                // Fetch item stats from Wowhead
                await fetchAllItemStats(itemIdsList);
                // Now display
                updateStatsDisplay(itemIdsList);
            } else {
                const statusDiv = document.getElementById('stats-status');
                if (statusDiv) statusDiv.innerHTML = '<span class="text-red-400">No valid items found</span>';
            }
        });

        // Gear input with debounce
        document.getElementById('gear-input').addEventListener('input', () => {
            clearTimeout(preRaidDebounceTimer);
            preRaidDebounceTimer = setTimeout(updateGearPreview, 300);
        });

        // Initial preview if there's existing text
        if (preRaidGearText) {
            updateGearPreview();
        }
    }, FADE_TRANSITION_MS);
}

function renderApiDocs() {
    currentClass = null;
    document.querySelectorAll('.class-list li').forEach(li => li.classList.remove('active'));
    const apiLink = document.querySelector('.class-list li[data-view="api"]');
    if (apiLink) apiLink.classList.add('active');
    const html = `
        <div class="command-line text-terminal-dim my-5 md:text-[11px] md:my-3 sm:text-[10px]">man tbc-api</div>
        <h2 class="text-terminal-accent text-lg mb-4 uppercase tracking-wide md:text-base md:mb-3 sm:text-sm">[ TBC.TXT API DOCUMENTATION ]</h2>
        <p class="text-terminal-dim text-xs mb-6 md:mb-4 sm:mb-3">REST API for accessing TBC PvE data in your own applications</p>
        <div class="border border-terminal-dim p-4 mb-6 md:p-3 md:mb-4 sm:p-2.5 sm:mb-3">
            <h3 class="text-terminal-accent text-sm mb-3 md:text-xs">// Base URL</h3>
            <pre class="bg-terminal-bg/50 p-3 text-xs text-terminal-text overflow-x-auto md:text-[11px] sm:text-[10px]"><code>https://api.tbctxt.io</code></pre>
        </div>
        <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ ENDPOINTS ]</h3>
        <div class="overflow-x-auto -mx-5 px-5 md:-mx-4 md:px-4 sm:-mx-3 sm:px-3">
            <table class="w-full border-collapse text-[13px] min-w-[600px] md:text-[11px] sm:text-[10px]">
                <thead>
                    <tr>
                        <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">ENDPOINT</th>
                        <th class="bg-terminal-dim text-terminal-bg p-2.5 text-left font-semibold uppercase text-[11px] tracking-widest md:p-2 md:text-[10px] sm:p-1.5 sm:text-[9px]">DESCRIPTION</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/health</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Server status and data counts</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/classes</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">List all classes with available specs</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/classes/{class}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Full class data (e.g., /api/classes/warrior)</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/classes/{class}/{spec}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Specific spec (e.g., /api/classes/warrior/fury)</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/items/search?q={query}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Search items by name</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/items/{name}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Get item ID by name</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/raids</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">All raid data by phase</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/raids/{phase}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Raids by phase (e.g., /api/raids/1)</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/recipes/{profession}</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Profession recipes</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/reference/enchants</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Enchant spell IDs</td></tr>
                    <tr class="border-b border-terminal-dim border-opacity-30"><td class="p-2.5 text-terminal-accent md:p-2 sm:p-1.5"><code>GET /api/reference/talents</code></td><td class="p-2.5 text-terminal-dim md:p-2 sm:p-1.5">Talent spell IDs</td></tr>
                </tbody>
            </table>
        </div>
        <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ EXAMPLE USAGE ]</h3>
        <div class="border border-terminal-dim p-4 mb-4 md:p-3 sm:p-2.5">
            <h4 class="text-terminal-accent text-xs mb-2">// JavaScript</h4>
            <pre class="bg-terminal-bg/50 p-3 text-xs text-terminal-dim overflow-x-auto md:text-[11px] sm:text-[10px]"><code>const response = await fetch('https://api.tbctxt.io/api/classes/warrior/fury');
const fury = await response.json();
console.log(fury.rotation);      // Rotation priority
console.log(fury.phases[1].bis); // Phase 1 BiS gear</code></pre>
        </div>
        <h3 class="text-terminal-text text-sm my-4 uppercase md:text-[13px] md:my-3 sm:text-xs">[ DATA FILES ]</h3>
        <p class="text-terminal-dim text-xs mb-3 md:text-[11px] sm:text-[10px]">Raw JSON files available in <code class="text-terminal-accent">/data/</code>:</p>
        <ul class="text-terminal-dim text-xs list-none space-y-1 md:text-[11px] sm:text-[10px]">
            <li>• <code class="text-terminal-accent">classData.json</code> - All class/spec data (701 KB)</li>
            <li>• <code class="text-terminal-accent">itemIds.json</code> - 36,000+ item IDs (1.2 MB)</li>
            <li>• <code class="text-terminal-accent">raidsData.json</code> - Raid/boss mechanics (132 KB)</li>
            <li>• <code class="text-terminal-accent">recipesData.json</code> - Profession recipes (81 KB)</li>
            <li>• <code class="text-terminal-accent">referenceData.json</code> - Enchants, talents, quests (19 KB)</li>
        </ul>
        <div class="mt-6 p-4 border border-terminal-accent border-opacity-30 bg-terminal-bg/50 md:mt-4 md:p-3 sm:mt-3 sm:p-2.5">
            <p class="text-terminal-dim text-xs md:text-[11px] sm:text-[10px]">CORS enabled on all endpoints. Read-only, no authentication required.</p>
        </div>
    `;
    const mainContent = document.getElementById('main-content');
    mainContent.style.opacity = '0.3';
    setTimeout(() => {
        mainContent.innerHTML = html;
        mainContent.style.opacity = '1';
    }, 200);
}
function navigateToHash(hash) {
    const target = hash.replace('#', '');
    if (!target) {
        renderClassContent('warrior');
        updateActiveNav('warrior');
        return;
    }

    const parts = target.split('/');
    const page = parts[0];

    if (page === 'recipes') {
        if (parts[1]) currentProfession = parts[1];
        renderRecipesContent();
    } else if (page === 'raids') {
        if (parts[1]) currentRaidPhase = parts[1];
        if (parts[2]) currentRaid = parts[2];
        renderRaidsContent();
    } else if (page === 'preraid') {
        renderPreRaidChecker();
    } else if (page === 'api') {
        renderApiDocs();
    } else {
        // Class page: #warrior or #warrior/arms or #warrior/arms/3
        currentClass = page;
        if (parts[1]) currentSpec = parts[1];
        if (parts[2]) currentPhase = parseInt(parts[2]);
        renderClassContent(page);
    }

    updateActiveNav(page);
}

function updateActiveNav(target) {
    const current = document.querySelector('.class-list li.active');
    if (current) current.classList.remove('active');
    const activeLink = document.querySelector(`.nav-link[data-class="${target}"], .nav-link[data-view="${target}"]`);
    if (activeLink) activeLink.parentElement.classList.add('active');
}

function initClassSelector() {
    document.querySelectorAll('.class-list li').forEach(li => {
        li.addEventListener('click', function(e) {
            if (e.ctrlKey || e.metaKey) return;
            e.preventDefault();
            const link = this.querySelector('.nav-link');
            if (link) window.location.hash = link.getAttribute('href');
        });
    });

    window.addEventListener('hashchange', () => navigateToHash(window.location.hash));

    if (window.location.hash) {
        navigateToHash(window.location.hash);
    }
}
window.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>